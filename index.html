<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Fair Discovery: The decentralized, AI-ranked directory.">
    <meta name="theme-color" content="#1a73e8">
    <title>Fair Discovery</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' x2='1' y1='0' y2='1'%3E%3Cstop offset='0%25' stop-color='%231a73e8'/%3E%3Cstop offset='100%25' stop-color='%238ab4f8'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cpath d='M50 5 L90 20 V50 C90 75 50 95 50 95 C50 95 10 75 10 50 V20 Z' fill='url(%23g)'/%3E%3Ccircle cx='50' cy='45' r='18' stroke='white' stroke-width='6' fill='none'/%3E%3Cline x1='62' y1='57' x2='75' y2='70' stroke='white' stroke-width='6' stroke-linecap='round'/%3E%3C/svg%3E">

    <style>
        /* --- VIBRANT VARIABLES --- */
        :root {
            --bg: #f4f7fa; --card-bg: #ffffff; --text: #1a1a1a; --text-sub: #666; 
            --border: #e1e4e8; --shadow: 0 8px 30px rgba(0,0,0,0.04);
            --accent: #1a73e8;
        }
        [data-theme="dark"] {
            --bg: #0f1115; --card-bg: #181b21; --text: #f0f0f0; --text-sub: #888;
            --border: #2a2e35; --shadow: 0 8px 30px rgba(0,0,0,0.2);
            --accent: #8ab4f8;
        }

        /* CATEGORY COLORS (The "Flavor") */
        .grad-auto { background: linear-gradient(135deg, #ff512f, #dd2476); }
        .grad-tech { background: linear-gradient(135deg, #434343, #000000); }
        .grad-health { background: linear-gradient(135deg, #11998e, #38ef7d); }
        .grad-service { background: linear-gradient(135deg, #3a6186, #89253e); }
        .grad-retail { background: linear-gradient(135deg, #fc4a1a, #f7b733); }
        .grad-artists { background: linear-gradient(135deg, #833ab4, #fd1d1d); }
        .grad-default { background: linear-gradient(135deg, #1a73e8, #0d47a1); }

        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; min-height: 100vh; transition: background 0.3s; -webkit-tap-highlight-color: transparent; }

        /* --- HEADER --- */
        header {
            padding: 50px 20px 30px; text-align: center; position: relative;
            background: var(--card-bg); border-bottom: 1px solid var(--border);
        }
        .header-controls { position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; }
        
        .btn-round {
            background: var(--bg); border: 1px solid var(--border); color: var(--text);
            padding: 8px 16px; border-radius: 50px; cursor: pointer; font-weight: 600; font-size: 0.85rem;
            transition: 0.2s; text-decoration: none; display: inline-flex; align-items: center; gap: 6px;
        }
        .btn-round:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-color: var(--accent); }
        
        h1 { font-size: 2.8rem; margin: 10px 0; letter-spacing: -1px; display: flex; justify-content: center; align-items: center; gap: 15px; }
        h1 span { background: linear-gradient(90deg, #1a73e8, #8ab4f8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .search-box {
            background: var(--card-bg); border: 2px solid var(--border); border-radius: 16px;
            padding: 16px 24px; width: 100%; max-width: 600px; font-size: 1.1rem; color: var(--text);
            outline: none; transition: 0.3s; margin: 20px auto; display: block;
            box-shadow: var(--shadow);
        }
        .search-box:focus { border-color: var(--accent); transform: scale(1.01); }

        .category-scroll { display: flex; gap: 10px; overflow-x: auto; padding: 10px 20px; justify-content: center; scrollbar-width: none; }
        .cat-pill {
            padding: 8px 18px; border-radius: 50px; font-weight: 600; font-size: 0.9rem;
            background: var(--bg); border: 1px solid var(--border); cursor: pointer;
            color: var(--text-sub); transition: 0.2s; flex-shrink: 0;
        }
        .cat-pill.active { background: var(--text); color: var(--card-bg); border-color: var(--text); }

        /* --- GRID --- */
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        .stats-bar { display: flex; justify-content: space-between; color: var(--text-sub); font-size: 0.9rem; margin-bottom: 20px; font-weight: 500; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px; }

        /* --- PREMIUM CARD --- */
        .card {
            background: var(--card-bg); border-radius: 16px; overflow: hidden;
            border: 1px solid var(--border); box-shadow: var(--shadow);
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer;
            position: relative; display: flex; flex-direction: column;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.12); border-color: var(--accent); }
        
        .card-banner { height: 60px; width: 100%; opacity: 0.9; }
        
        .card-content { padding: 15px 20px 20px; flex: 1; display: flex; flex-direction: column; margin-top: -30px; }
        
        .card-brand { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 10px; }
        .card-logo { 
            width: 50px; height: 50px; border-radius: 12px; background: var(--card-bg); 
            display: flex; align-items: center; justify-content: center; font-size: 1.5rem; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 2px solid var(--card-bg);
        }
        .verified-tag { background: rgba(30,142,62,0.1); color: #1e8e3e; padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        
        .card-title { font-size: 1.2rem; font-weight: 700; margin: 0; color: var(--text); line-height: 1.3; }
        .card-desc { font-size: 0.9rem; color: var(--text-sub); margin-top: 8px; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        .deal-badge { 
            background: linear-gradient(135deg, #FF512F, #DD2476); color: white; 
            font-size: 0.7rem; padding: 4px 10px; border-radius: 20px; font-weight: 700;
            display: inline-block; margin-top: 10px; box-shadow: 0 2px 5px rgba(255, 81, 47, 0.3);
        }

        .card-footer { 
            margin-top: auto; padding-top: 15px; display: flex; justify-content: space-between; align-items: center; 
            border-top: 1px solid var(--border); 
        }
        .authority-score { font-size: 1.1rem; font-weight: 800; color: var(--text); }
        .authority-label { font-size: 0.7rem; text-transform: uppercase; color: var(--text-sub); font-weight: 600; }

        /* --- PROFILE MODAL --- */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.4); backdrop-filter: blur(8px); z-index: 1000;
            display: none; align-items: center; justify-content: center;
            animation: fadeIn 0.2s ease-out;
        }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
        
        .modal-card {
            background: var(--card-bg); width: 90%; max-width: 500px; border-radius: 24px; 
            overflow: hidden; box-shadow: 0 25px 80px rgba(0,0,0,0.4);
            transform: scale(0.95); animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes popUp { to{transform: scale(1)} }
        
        .modal-banner { height: 140px; display: flex; align-items: center; justify-content: center; padding: 20px; text-align: center; color: white; position: relative; }
        .modal-quote { font-family: Georgia, serif; font-style: italic; font-size: 1.1rem; line-height: 1.4; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .modal-close { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.2); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .modal-close:hover { background: rgba(0,0,0,0.5); transform: rotate(90deg); }

        .modal-content { padding: 0 25px 25px; }
        .modal-header { display: flex; justify-content: space-between; align-items: flex-end; margin-top: -40px; margin-bottom: 15px; }
        .modal-logo { width: 80px; height: 80px; background: var(--card-bg); border-radius: 20px; font-size: 2.5rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        
        .action-btn { 
            flex: 1; padding: 12px; border-radius: 12px; text-align: center; font-weight: 600; 
            text-decoration: none; transition: 0.2s; 
        }
        .btn-main { background: var(--text); color: var(--card-bg); }
        .btn-sec { background: var(--bg); color: var(--text); }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

        /* STAR RATING */
        .star-row { display: flex; gap: 10px; justify-content: center; margin-top: 10px; background: var(--bg); padding: 15px; border-radius: 16px; }
        .star-btn { background: none; border: none; font-size: 1.8rem; cursor: pointer; color: #d1d5db; transition: 0.2s; }
        .star-btn:hover { color: #fbbf24; transform: scale(1.2); }

        /* FOOTER */
        footer { margin-top: 60px; padding: 40px 20px; text-align: center; border-top: 1px solid var(--border); color: var(--text-sub); font-size: 0.9rem; }
        
        /* INSTALL PWA BUTTON (Hidden on Desktop usually) */
        #installBtn { display: none; }

        @media (max-width: 600px) {
            .categories { justify-content: flex-start; }
            .modal-card { width: 100%; height: 100%; border-radius: 0; max-width: none; margin: 0; }
            .modal-close { top: 20px; right: 20px; background: rgba(0,0,0,0.5); }
        }
    </style>
</head>
<body>

<header>
    <div class="header-controls">
        <button id="installBtn" class="btn-round" onclick="installPWA()">üì≤ Install App</button>
        <button class="btn-round" onclick="toggleTheme()">üåô</button>
        <button class="btn-round" onclick="openJoin()">üöÄ Join</button>
    </div>

    <h1>
        <svg width="40" height="40" viewBox="0 0 100 100" fill="none"><defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#1a73e8"/><stop offset="1" stop-color="#8ab4f8"/></linearGradient></defs><path d="M50 5 L90 20 V50 C90 75 50 95 50 95 C50 95 10 75 10 50 V20 Z" fill="url(#g)"/><circle cx="50" cy="45" r="16" stroke="white" stroke-width="6" fill="none"/><line x1="60" y1="55" x2="72" y2="67" stroke="white" stroke-width="6" stroke-linecap="round"/></svg>
        <span>Fair Discovery</span>
    </h1>
    <p style="color:var(--text-sub); margin-bottom:20px;">The decentralized directory ranked by real humans.</p>

    <input type="text" class="search-box" id="searchInput" placeholder="Try 'mechanic' or 'designer'...">
    
    <div class="category-scroll">
        <div class="cat-pill active" onclick="filter('all')">All</div>
        <div class="cat-pill" onclick="filter('Auto')">üöó Auto</div>
        <div class="cat-pill" onclick="filter('Tech')">üíª Tech</div>
        <div class="cat-pill" onclick="filter('Health')">üè• Health</div>
        <div class="cat-pill" onclick="filter('Service')">üõ†Ô∏è Services</div>
        <div class="cat-pill" onclick="filter('Artists')">üé® Artists</div>
    </div>
</header>

<div class="container">
    <div class="stats-bar">
        <span id="statsLabel">Scanning network...</span>
        <span>Global Feed</span>
    </div>
    <div id="grid" class="grid"></div>
    <div class="pagination" id="pagination"></div>
</div>

<footer>
    <p>Fair Discovery is open source and free forever.</p>
    <div style="margin: 20px 0;">
        <a href="https://www.buymeacoffee.com/Prinymity" target="_blank" class="btn-round" style="background:#FFDD00; border:none; color:black;">‚òï Support the Dev</a>
    </div>
    <p style="opacity:0.6;">Powered by Gemini ‚Ä¢ GitHub ‚Ä¢ The Fair Collective</p>
</footer>

<div id="profileModal" class="modal-backdrop" onclick="closeProfile()">
    <div class="modal-card" onclick="event.stopPropagation()">
        <div class="modal-banner" id="pBanner">
            <div class="modal-quote" id="pQuote">"Truth is the only safe ground."</div>
            <div class="modal-close" onclick="closeProfile()">‚úï</div>
        </div>
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-logo" id="pLogo">üåê</div>
                <div style="text-align:right;">
                    <div class="authority-score" id="pScore">0</div>
                    <div class="authority-label">Authority Score</div>
                </div>
            </div>
            
            <h2 id="pTitle" style="margin:0 0 5px 0;">Business Name</h2>
            <p id="pMeta" style="color:var(--text-sub); margin:0;">Category ‚Ä¢ Location</p>
            
            <p id="pDesc" style="margin: 20px 0; line-height:1.6;">Description...</p>

            <div style="display:flex; gap:10px; margin-bottom:25px;">
                <a id="pActionMap" href="#" target="_blank" class="action-btn btn-sec">üìç Map</a>
                <a id="pActionSite" href="#" target="_blank" class="action-btn btn-main">Visit ‚Üó</a>
            </div>

            <div class="star-row">
                <button class="star-btn" onclick="rate(1)">‚òÖ</button>
                <button class="star-btn" onclick="rate(2)">‚òÖ</button>
                <button class="star-btn" onclick="rate(3)">‚òÖ</button>
                <button class="star-btn" onclick="rate(4)">‚òÖ</button>
                <button class="star-btn" onclick="rate(5)">‚òÖ</button>
            </div>
            <p style="text-align:center; font-size:0.8rem; color:var(--text-sub); margin-top:5px;">Rate anonymously via Google Forms</p>
        </div>
    </div>
</div>

<script>
    // --- PWA INSTALLER ---
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault(); deferredPrompt = e;
        document.getElementById('installBtn').style.display = 'inline-flex';
    });
    function installPWA() {
        if(deferredPrompt) { deferredPrompt.prompt(); deferredPrompt = null; }
    }
    if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');

    // --- LOGIC ---
    const FEED_URL = 'data.json'; 
    let allData = [], filteredData = [], currentPage = 1; const limit = 12; let curCat = 'all';
    let currentBusiness = "";
    
    const quotes = [
        "\"Honesty is the first chapter in the book of wisdom.\"",
        "\"Transparency is the currency of trust.\"",
        "\"Quality means doing it right when no one is looking.\"",
        "\"Fairness is not an attitude. It's a skill.\""
    ];

    function toggleTheme() {
        const b = document.body;
        b.setAttribute('data-theme', b.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
    }

    async function init() {
        try {
            const res = await fetch(FEED_URL + '?' + Date.now());
            const json = await res.json();
            processData(json.pages || []);
        } catch (e) { document.getElementById('grid').innerHTML = '<p style="text-align:center">Loading network...</p>'; }
    }

    function processData(pages) {
        const domainMap = {};
        pages.forEach(p => {
            try {
                const u = new URL(p.url.startsWith('http') ? p.url : 'https://' + p.url);
                const d = u.hostname;
                if (!domainMap[d]) {
                    domainMap[d] = {
                        domain: d, fullUrl: u.origin, score: 0, 
                        cat: p.category || inferCat(d), 
                        desc: p.description || "Verified listing.",
                        wa: p.whatsapp, loc: p.location || "Global",
                        deal: p.deal // COUPON SUPPORT
                    };
                }
                domainMap[d].score += p.score;
                if(p.category) domainMap[d].cat = p.category;
                if(p.description) domainMap[d].desc = p.description;
            } catch(e){}
        });
        allData = Object.values(domainMap).sort((a,b) => b.score - a.score);
        filter('all');
    }

    function inferCat(d) {
        if(d.includes('auto')||d.includes('panel')||d.includes('motor')) return 'Auto';
        if(d.includes('tech')||d.includes('app')) return 'Tech';
        if(d.includes('health')) return 'Health';
        if(d.includes('art')) return 'Artists';
        return 'Service';
    }

    function filter(cat) {
        curCat = cat;
        document.querySelectorAll('.cat-pill').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
        
        const term = document.getElementById('searchInput').value.toLowerCase();
        const tokens = term.split(' ').filter(t => t.length > 0);

        filteredData = allData.filter(i => {
            const matchesCat = curCat === 'all' || i.cat === curCat;
            const text = (i.domain + i.desc + i.cat + i.loc + formatTitle(i.domain)).toLowerCase();
            const matchesSearch = tokens.every(t => text.includes(t));
            return matchesCat && matchesSearch;
        });
        currentPage = 1; render();
    }

    function render() {
        const grid = document.getElementById('grid'); grid.innerHTML = '';
        document.getElementById('statsLabel').innerText = `Found ${filteredData.length} sites`;
        
        const start = (currentPage - 1) * limit;
        const slice = filteredData.slice(start, start + limit);
        
        slice.forEach((item, idx) => {
            let flag = item.domain.endsWith('.za') ? 'üáøüá¶' : 'üåê';
            let bannerClass = `grad-${item.cat.toLowerCase()}` || 'grad-default';
            let dealBadge = item.deal ? `<div class="deal-badge">üî• ${item.deal}</div>` : '';
            
            const card = document.createElement('div');
            card.className = 'card';
            card.onclick = () => openProfile(start + idx);
            card.innerHTML = `
                <div class="card-banner ${bannerClass}"></div>
                <div class="card-content">
                    <div class="card-brand">
                        <div class="card-logo">${flag}</div>
                        <span class="verified-tag">‚úì Verified</span>
                    </div>
                    <h3 class="card-title">${formatTitle(item.domain)}</h3>
                    <span style="font-size:0.8rem; color:#999">${item.domain.replace('.local','')}</span>
                    ${dealBadge}
                    <p class="card-desc">${item.desc}</p>
                    <div class="card-footer">
                        <div class="authority-label">Authority Score</div>
                        <div class="authority-score">${formatScore(item.score)}</div>
                    </div>
                </div>
            `;
            grid.appendChild(card);
        });
        renderPag();
    }

    function openProfile(idx) {
        const item = filteredData[idx];
        currentBusiness = formatTitle(item.domain);
        
        document.getElementById('pBanner').className = `modal-banner grad-${item.cat.toLowerCase()}`;
        document.getElementById('pQuote').innerText = quotes[Math.floor(Math.random() * quotes.length)];
        document.getElementById('pTitle').innerText = currentBusiness;
        document.getElementById('pMeta').innerText = `${item.cat} ‚Ä¢ ${item.loc}`;
        document.getElementById('pDesc').innerText = item.desc;
        document.getElementById('pScore').innerText = formatScore(item.score);
        
        // Smart Links
        let link = item.fullUrl;
        if(item.domain.includes('.local') && item.wa) link = `https://wa.me/${item.wa}`;
        document.getElementById('pActionSite').href = link;
        
        let map = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(currentBusiness + ' ' + item.loc)}`;
        if(item.domain.includes('greyzone')) map = "https://share.google/1O2Kl72Vige48vGsB";
        if(item.domain.includes('aolocksmith')) map = "https://share.google/WNjzMAwNlj9tC3u6F";
        document.getElementById('pActionMap').href = map;
        
        document.getElementById('profileModal').style.display = 'flex';
    }

    function closeProfile() { document.getElementById('profileModal').style.display = 'none'; }
    
    function rate(stars) {
        const formId = "1FAIpQLSefrTrv68_G_l-6-6J41szCGqg_DcTxklCcWAPJ6e-_oV0k8A";
        const url = `https://docs.google.com/forms/d/e/${formId}/viewform?usp=pp_url&entry.1871531298=${encodeURIComponent(currentBusiness)}&entry.741708013=${stars}`;
        window.open(url, '_blank');
    }

    function formatTitle(d) {
        if(d.includes("greyzone")) return "Grey Zone Auto Parts";
        if(d.includes("aolocksmith")) return "AO Locksmith";
        if(d.includes("autods")) return "Auto Digital Solutions";
        if(d.includes("bookkeepers")) return "Bookkeepers SA";
        if(d.includes("seritipbo")) return "Seriti PBO";
        if(d.includes("scouts")) return "Save Our Children";
        if(d.includes("jotto")) return "Jotto's Portfolio";
        if(d.includes("skyrope")) return "Sky Rope Specialist";
        if(d.includes("intpanel")) return "International Panel Shop";
        return d.split('.')[0].charAt(0).toUpperCase() + d.split('.')[0].slice(1);
    }

    function formatScore(n) {
        if(n > 1000000) return (n/1000000).toFixed(1) + 'M';
        if(n > 1000) return (n/1000).toFixed(1) + 'k';
        return n;
    }

    function renderPag() {
        const el = document.getElementById('pagination'); el.innerHTML = '';
        const pages = Math.ceil(filteredData.length / limit);
        if(pages <= 1) return;
        for(let i=1; i<=pages; i++) {
            el.innerHTML += `<button class="page-btn ${i===currentPage?'active':''}" onclick="currentPage=${i};render();window.scrollTo(0,0)">${i}</button>`;
        }
    }

    function openJoin() {
        const url = "https://github.com/fair-collective/fair-discovery/issues/new?title=Add%20Site";
        window.open(url, '_blank');
    }

    document.getElementById('searchInput').addEventListener('input', filter);
    init();
</script>
</body>
</html>
