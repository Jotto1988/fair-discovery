<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Fair Discovery: The decentralized, AI-ranked directory.">
    <title>Fair Discovery</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' x2='1'%3E%3Cstop offset='0' stop-color='%231a73e8'/%3E%3Cstop offset='1' stop-color='%236ce0ff'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cpath d='M50 6 L88 20 V50 C88 74 50 94 50 94 C50 94 12 74 12 50 V20 Z' fill='url(%23g)'/%3E%3Ccircle cx='50' cy='44' r='14' stroke='white' stroke-width='5' fill='none'/%3E%3C/svg%3E">

    <style>
        :root {
            --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --sub: #94a3b8;
            --border: #334155; --primary: #3b82f6; --success: #22c55e;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        [data-theme="light"] {
            --bg: #f8fafc; --card: #ffffff; --text: #0f172a; --sub: #64748b;
            --border: #e2e8f0; --primary: #2563eb; --success: #16a34a;
        }

        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; min-height: 100vh; }
        
        /* HEADER */
        header { background: var(--card); border-bottom: 1px solid var(--border); padding: 20px; }
        .header-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        
        .brand { display: flex; align-items: center; gap: 10px; font-weight: 800; font-size: 1.4rem; color: var(--text); }
        .brand svg { width: 32px; height: 32px; }
        
        .controls { display: flex; gap: 10px; align-items: center; }
        select, button { padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); cursor: pointer; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; border-color: var(--primary); font-weight: 600; text-decoration: none; display: inline-block; }
        
        /* FILTERS */
        .filters { max-width: 1200px; margin: 20px auto; padding: 0 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        .search-box { flex: 1; min-width: 250px; padding: 10px 15px; border-radius: 8px; border: 1px solid var(--border); background: var(--card); color: var(--text); }
        
        .cats { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; width: 100%; }
        .pill { padding: 6px 14px; border-radius: 20px; background: var(--card); border: 1px solid var(--border); cursor: pointer; white-space: nowrap; font-size: 0.85rem; color: var(--sub); transition: 0.2s; }
        .pill:hover, .pill.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* GRID */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; flex: 1; width: 100%; box-sizing: border-box; }
        .stats { display: flex; justify-content: space-between; color: var(--sub); font-size: 0.85rem; margin-bottom: 15px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }

        /* CARD */
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; transition: transform 0.2s; cursor: pointer; display: flex; flex-direction: column; }
        .card:hover { transform: translateY(-4px); border-color: var(--primary); }
        
        .banner { height: 100px; background-size: cover; background-position: center; background-color: var(--bg); }
        .card-body { padding: 15px; position: relative; flex: 1; }
        .card-logo { width: 48px; height: 48px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; position: absolute; top: -24px; left: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .verified { position: absolute; top: 10px; right: 15px; font-size: 0.7rem; font-weight: 700; color: var(--success); background: rgba(34, 197, 94, 0.1); padding: 3px 8px; border-radius: 4px; }
        
        .title { margin: 25px 0 5px; font-size: 1.1rem; font-weight: 700; }
        .meta { font-size: 0.85rem; color: var(--sub); margin-bottom: 8px; }
        .desc { font-size: 0.9rem; color: var(--sub); line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        /* FOOTER */
        footer { background: var(--card); border-top: 1px solid var(--border); padding: 30px; text-align: center; color: var(--sub); font-size: 0.9rem; }
        footer a { color: var(--primary); text-decoration: none; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(2px); }
        .modal { background: var(--card); width: 100%; max-width: 500px; border-radius: 16px; overflow: hidden; position: relative; border: 1px solid var(--border); box-shadow: 0 20px 50px rgba(0,0,0,0.5); display: flex; flex-direction: column; max-height: 90vh; }
        .modal-close { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.5); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; }
        
        .modal-content { padding: 20px; overflow-y: auto; }
        .btn-visit { display: block; background: var(--primary); color: white; text-align: center; padding: 12px; border-radius: 8px; text-decoration: none; font-weight: 700; margin-top: 15px; }
        
        .rating-row { display: flex; justify-content: center; gap: 10px; margin-top: 20px; border-top: 1px solid var(--border); padding-top: 20px; }
        .star { font-size: 1.5rem; background: none; border: none; cursor: pointer; color: var(--border); transition: 0.2s; }
        .star:hover { color: #eab308; transform: scale(1.2); }

        @media(max-width: 600px) {
            .header-content { flex-direction: column; align-items: stretch; }
            .controls { justify-content: space-between; }
        }
    </style>
</head>
<body>

<header>
    <div class="header-content">
        <div class="brand">
            <svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="#1a73e8"/><circle cx="50" cy="50" r="20" fill="none" stroke="white" stroke-width="8"/><line x1="65" y1="65" x2="85" y2="85" stroke="white" stroke-width="8" stroke-linecap="round"/></svg>
            Fair Discovery
        </div>
        <div class="controls">
            <a href="https://github.com/fair-collective/fair-discovery/issues/new?title=Add%20Site" target="_blank" class="btn-primary" style="padding:8px 16px; border-radius:8px; font-size:0.9rem;">üöÄ Join</a>
            <button onclick="toggleTheme()">üåô</button>
            <select onchange="alert('Language support coming in v2')">
                <option>üá∫üá∏ EN</option><option>üá™üá∏ ES</option><option>üá´üá∑ FR</option>
            </select>
        </div>
    </div>
</header>

<div class="filters">
    <input type="text" id="search" class="search-box" placeholder="Search services...">
    <select id="locFilter" onchange="filter()" style="min-width: 150px;">
        <option value="all">üåç Global</option>
    </select>
</div>

<div class="container">
    <div class="cats" id="catContainer">
        </div>
    
    <div class="stats">
        <span id="count">Loading...</span>
        <span>Network Live</span>
    </div>

    <div id="grid" class="grid"></div>
</div>

<footer>
    <p>Fair Discovery ¬© 2025 ‚Ä¢ Open Source</p>
    <a href="https://github.com/fair-collective" target="_blank">GitHub</a> ‚Ä¢ <a href="data.json" target="_blank">API</a>
    <br><br>
    <a href="https://www.buymeacoffee.com/Prinymity" target="_blank" class="btn-primary" style="background:#FFDD00; color:black;">‚òï Support</a>
</footer>

<div id="modal" class="modal-overlay" onclick="closeModal()">
    <div class="modal" onclick="event.stopPropagation()">
        <div id="mBanner" class="banner">
            <div class="modal-close" onclick="closeModal()">‚úï</div>
        </div>
        <div class="modal-content">
            <h2 id="mTitle" style="margin:0">Business</h2>
            <p id="mMeta" style="color:var(--sub); margin-top:5px">Category ‚Ä¢ Location</p>
            <p id="mDesc" style="line-height:1.6">Description...</p>
            
            <div style="background:var(--bg); padding:15px; border-radius:8px; margin-top:15px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span>üìç Location:</span>
                    <span id="mLoc" style="font-weight:600">City</span>
                </div>
                <div style="display:flex; justify-content:space-between;">
                    <span>üìû Contact:</span>
                    <span id="mPhone" style="font-weight:600">Num</span>
                </div>
            </div>

            <a id="mLink" href="#" target="_blank" class="btn-visit">Visit Website ‚Üó</a>

            <div class="rating-row">
                <button class="star" onclick="rate(1)">‚òÖ</button>
                <button class="star" onclick="rate(2)">‚òÖ</button>
                <button class="star" onclick="rate(3)">‚òÖ</button>
                <button class="star" onclick="rate(4)">‚òÖ</button>
                <button class="star" onclick="rate(5)">‚òÖ</button>
            </div>
            <p style="text-align:center; font-size:0.8rem; color:var(--sub); margin:5px 0 0;">Rate Anonymously</p>
        </div>
    </div>
</div>

<script>
    const FEED = 'data.json';
    let allData = [], filtered = [], curCat = 'all';
    let currentBiz = "";

    const images = {
        'Auto': 'https://images.unsplash.com/photo-1486262715619-01b8c22973f5?w=600&q=80',
        'Tech': 'https://images.unsplash.com/photo-1518770660439-4636190af475?w=600&q=80',
        'Health': 'https://images.unsplash.com/photo-1505751172876-fa1923c5c528?w=600&q=80',
        'Service': 'https://images.unsplash.com/photo-1581578077058-612788a8966c?w=600&q=80',
        'Retail': 'https://images.unsplash.com/photo-1441986300917-64674bd600d8?w=600&q=80',
        'Artists': 'https://images.unsplash.com/photo-1460661419201-fd4cecdf8a8b?w=600&q=80',
        'Real Estate': 'https://images.unsplash.com/photo-1560518883-ce09059eeffa?w=600&q=80',
        'Travel': 'https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1?w=600&q=80'
    };

    function toggleTheme() {
        const root = document.documentElement;
        const theme = root.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        root.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
    }
    if(localStorage.getItem('theme') === 'light') toggleTheme();

    async function init() {
        try {
            const res = await fetch(FEED + '?' + Date.now());
            const json = await res.json();
            const map = {};
            
            (json.pages || []).forEach(p => {
                try {
                    let u = p.url.startsWith('http') ? p.url : 'https://'+p.url;
                    let d = new URL(u).hostname;
                    if(!map[d]) map[d] = {
                        domain: d, url: p.url, score: 0,
                        cat: p.category || "Service",
                        desc: p.description || "Verified Listing",
                        wa: p.whatsapp, loc: p.location, deal: p.deal
                    };
                    map[d].score += p.score;
                    if(p.category) map[d].cat = p.category;
                    if(p.description) map[d].desc = p.description;
                } catch(e){}
            });

            allData = Object.values(map).sort((a,b) => b.score - a.score);
            
            // Setup Categories
            const cats = ['All', 'Auto', 'Tech', 'Health', 'Service', 'Retail', 'Artists', 'Real Estate', 'Travel'];
            const catContainer = document.getElementById('catContainer');
            cats.forEach(c => {
                const val = c === 'All' ? 'all' : c;
                catContainer.innerHTML += `<div class="pill ${val==='all'?'active':''}" onclick="setCat('${val}', this)">${c}</div>`;
            });

            // Setup Locations
            const locSet = new Set();
            allData.forEach(i => {
                if(i.loc) {
                    locSet.add(i.loc);
                    if(i.loc.includes(',')) locSet.add(i.loc.split(',')[1].trim());
                }
            });
            const locSelect = document.getElementById('locFilter');
            [...locSet].sort().forEach(l => {
                locSelect.innerHTML += `<option value="${l}">${l}</option>`;
            });

            filter();
        } catch(e) { document.getElementById('grid').innerHTML = '<p style="text-align:center">Loading error. Check back soon.</p>'; }
    }

    function setCat(c, el) {
        curCat = c;
        document.querySelectorAll('.pill').forEach(e => e.classList.remove('active'));
        el.classList.add('active');
        filter();
    }

    function filter() {
        const term = document.getElementById('search').value.toLowerCase();
        const loc = document.getElementById('locFilter').value;
        
        filtered = allData.filter(i => {
            const matchCat = curCat === 'all' || i.cat === curCat;
            let matchLoc = loc === 'all';
            if (!matchLoc && i.loc) matchLoc = i.loc.includes(loc);
            const text = (i.domain + i.desc + i.cat).toLowerCase();
            return matchCat && matchLoc && text.includes(term);
        });
        render();
    }

    function render() {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        document.getElementById('count').innerText = `Found ${filtered.length}`;
        
        filtered.forEach((item, idx) => {
            let flag = item.domain.endsWith('.za') ? 'üáøüá¶' : 'üåê';
            let img = images[item.cat] || images['Service'];
            let title = formatTitle(item.domain);

            const card = document.createElement('div');
            card.className = 'card';
            card.onclick = () => openModal(idx);
            
            let dealHtml = item.deal ? `<span style="color:#e11d48; font-weight:bold; font-size:0.8rem; display:block; margin-top:5px;">üî• ${item.deal}</span>` : '';

            card.innerHTML = `
                <div class="banner" style="background-image:url('${img}')"></div>
                <div class="card-body">
                    <div class="card-logo">${flag}</div>
                    <span class="verified">‚úì VERIFIED</span>
                    <h3 class="title">${title}</h3>
                    <div class="meta">${item.domain.replace('.local','')}</div>
                    <p class="desc">${item.desc}</p>
                    ${dealHtml}
                    <div class="card-footer">
                        <span>${item.cat}</span>
                        <span class="score">${(item.score>1000?(item.score/1000).toFixed(1)+'k':item.score)}</span>
                    </div>
                </div>
            `;
            grid.appendChild(card);
        });
    }

    function openModal(idx) {
        const i = filtered[idx];
        currentBiz = formatTitle(i.domain);
        
        let img = images[i.cat] || images['Service'];
        document.getElementById('mBanner').style.backgroundImage = `url('${img}')`;
        
        document.getElementById('mTitle').innerText = currentBiz;
        document.getElementById('mMeta').innerText = `${i.cat} ‚Ä¢ ${i.loc || 'Global'}`;
        document.getElementById('mDesc').innerText = i.desc;
        document.getElementById('mLoc').innerText = i.loc || 'Global';
        document.getElementById('mPhone').innerText = i.wa ? '+' + i.wa : 'N/A';
        
        let link = i.url;
        if(i.domain.includes('.local') && i.wa) link = `https://wa.me/${i.wa}`;
        document.getElementById('mLink').href = link;
        
        document.getElementById('modal').style.display = 'flex';
    }

    function closeModal() { document.getElementById('modal').style.display = 'none'; }

    function formatTitle(d) {
        if(d.includes("greyzone")) return "Grey Zone Auto Parts";
        if(d.includes("aolocksmith")) return "AO Locksmith";
        if(d.includes("autods")) return "Auto Digital Solutions";
        if(d.includes("bookkeepers")) return "Bookkeepers SA";
        if(d.includes("seritipbo")) return "Seriti PBO";
        if(d.includes("scouts")) return "Save Our Children";
        if(d.includes("jotto")) return "Jotto's Portfolio";
        if(d.includes("skyrope")) return "Sky Rope Specialist";
        if(d.includes("intpanel")) return "International Panel Shop";
        return d.split('.')[0].charAt(0).toUpperCase() + d.split('.')[0].slice(1);
    }

    function rate(stars) {
        const formId = "1FAIpQLSefrTrv68_G_l-6-6J41szCGqg_DcTxklCcWAPJ6e-_oV0k8A";
        const url = `https://docs.google.com/forms/d/e/${formId}/viewform?usp=pp_url&entry.1871531298=${encodeURIComponent(currentBiz)}&entry.741708013=${stars}`;
        window.open(url, '_blank');
    }

    document.getElementById('search').addEventListener('input', filter);
    init();
</script>
</body>
</html>
