<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<meta name="description" content="Fair Discovery: The decentralized, AI-ranked directory of authentic businesses." />
<meta name="theme-color" content="#1a73e8" />
<title>Fair Discovery Directory</title>

<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' x2='1'%3E%3Cstop offset='0' stop-color='%231a73e8'/%3E%3Cstop offset='1' stop-color='%236ce0ff'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cpath d='M50 6 L88 20 V50 C88 74 50 94 50 94 C50 94 12 74 12 50 V20 Z' fill='url(%23g)'/%3E%3Ccircle cx='50' cy='44' r='14' stroke='white' stroke-width='5' fill='none'/%3E%3C/svg%3E">

<style>
  /* ---------- THEME VARIABLES (Dark Default) ---------- */
  :root {
    --bg: #0f1723;
    --surface: #0b1220;
    --card-bg: #08101a;
    --text: #e6eef7;
    --sub: #9fb0c8;
    --muted: #64748b;
    --border: rgba(255,255,255,0.08);
    --accentA: #1a73e8;
    --accentB: #6ce0ff;
    --glass: rgba(255,255,255,0.05);
    --shadow: 0 8px 28px rgba(0,0,0,0.6);
    --success: #1e8e3e;
    font-family: Inter, "Google Sans", Roboto, sans-serif;
  }

  /* Light Mode Override */
  :root[data-theme="light"] {
    --bg: #f6f8fb;
    --surface: #ffffff;
    --card-bg: #ffffff;
    --text: #0b1220;
    --sub: #4b5563;
    --muted: #9ca3af;
    --border: #e5e7eb;
    --glass: rgba(0,0,0,0.03);
    --shadow: 0 10px 30px rgba(0,0,0,0.05);
  }

  /* ---------- RESET & BASE ---------- */
  html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); transition: background 0.3s, color 0.3s; }
  * { box-sizing: border-box; }
  a { color: inherit; text-decoration: none; }
  
  /* Main Container to prevent overflow */
  .app-wrapper {
    max-width: 1200px; margin: 0 auto; padding: 0 20px;
    display: flex; flex-direction: column; min-height: 100vh;
  }

  /* ---------- HEADER ---------- */
  header {
    padding: 20px 0; border-bottom: 1px solid var(--border);
    display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;
  }
  
  .brand { display: flex; align-items: center; gap: 12px; }
  .brand svg { width: 42px; height: 42px; flex-shrink: 0; }
  h1 { font-size: 1.4rem; margin: 0; background: linear-gradient(90deg, var(--accentA), var(--accentB)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  .subtitle { font-size: 0.85rem; color: var(--sub); display: none; } /* Hidden on mobile to save space */

  .controls { display: flex; gap: 8px; align-items: center; }
  
  .btn {
    background: linear-gradient(90deg, var(--accentA), var(--accentB)); color: white;
    padding: 8px 16px; border-radius: 50px; border: none; cursor: pointer;
    font-weight: 600; font-size: 0.9rem; box-shadow: 0 4px 12px rgba(26,115,232,0.3);
    transition: transform 0.2s;
  }
  .btn:hover { transform: translateY(-2px); }
  
  .btn-ghost {
    background: var(--glass); border: 1px solid var(--border); color: var(--text);
    width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: 0.2s;
  }
  .btn-ghost:hover { border-color: var(--accentA); }

  /* Dropdown Fix */
  select.lang-select {
    background: var(--glass); border: 1px solid var(--border); color: var(--text);
    padding: 8px; border-radius: 8px; outline: none; cursor: pointer;
  }
  select.lang-select option { background: var(--bg); color: var(--text); } /* Fixes invisible text */

  /* ---------- FILTERS ---------- */
  .filters { display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap; }
  
  .search-box {
    flex: 2; min-width: 200px; position: relative;
  }
  .search-box input {
    width: 100%; padding: 12px 40px 12px 15px; border-radius: 12px;
    border: 1px solid var(--border); background: var(--glass); color: var(--text);
    font-size: 1rem; outline: none;
  }
  .search-box input:focus { border-color: var(--accentA); }
  
  .select-box {
    flex: 1; min-width: 140px; padding: 12px; border-radius: 12px;
    border: 1px solid var(--border); background: var(--glass); color: var(--text);
    cursor: pointer; outline: none;
  }
  .select-box option { background: var(--bg); color: var(--text); }

  /* ---------- GRID ---------- */
  .stats { display: flex; justify-content: space-between; color: var(--muted); font-size: 0.85rem; margin-bottom: 15px; }
  
  .grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;
    padding-bottom: 40px;
  }

  .card {
    background: var(--card-bg); border: 1px solid var(--border); border-radius: 16px;
    overflow: hidden; display: flex; flex-direction: column; position: relative;
    transition: transform 0.2s, box-shadow 0.2s; cursor: pointer;
  }
  .card:hover { transform: translateY(-5px); box-shadow: var(--shadow); border-color: var(--accentA); }
  
  .card-banner { height: 100px; background-size: cover; background-position: center; position: relative; }
  .card-banner::after { content:''; position: absolute; inset:0; background: linear-gradient(to bottom, transparent, rgba(0,0,0,0.6)); }
  
  .card-body { padding: 15px; position: relative; flex: 1; display: flex; flex-direction: column; }
  
  .card-logo {
    width: 50px; height: 50px; background: var(--card-bg); border-radius: 12px;
    display: flex; align-items: center; justify-content: center; font-size: 1.5rem;
    position: absolute; top: -25px; left: 15px; border: 2px solid var(--card-bg);
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  }
  
  .card-badges { position: absolute; top: 10px; right: 10px; display: flex; flex-direction: column; align-items: flex-end; gap: 5px; }
  .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
  .badge-verified { background: rgba(30,142,62,0.15); color: #2e7d32; }
  .badge-deal { background: linear-gradient(135deg, #FF512F, #DD2476); color: white; box-shadow: 0 2px 6px rgba(255,81,47,0.3); }

  .card-title { margin: 25px 0 5px; font-size: 1.1rem; font-weight: 700; }
  .card-meta { font-size: 0.85rem; color: var(--sub); margin-bottom: 10px; }
  .card-desc { font-size: 0.9rem; color: var(--muted); line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; flex: 1; }
  
  .card-footer { margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: var(--sub); }
  .score { font-weight: 700; color: var(--accentA); font-size: 1rem; }

  /* ---------- FOOTER ---------- */
  footer { text-align: center; padding: 40px 0; border-top: 1px solid var(--border); margin-top: auto; color: var(--muted); font-size: 0.9rem; }
  footer a { color: var(--accentB); }
  footer a:hover { text-decoration: underline; }

  /* ---------- MODAL ---------- */
  .modal-overlay { 
    position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
    z-index: 100; display: none; align-items: center; justify-content: center; padding: 20px;
  }
  .modal-card {
    background: var(--card-bg); width: 100%; max-width: 500px; border-radius: 20px;
    overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); position: relative;
    max-height: 90vh; overflow-y: auto; animation: slideUp 0.2s ease;
  }
  @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  
  .modal-close { 
    position: absolute; top: 15px; right: 15px; width: 32px; height: 32px;
    background: rgba(255,255,255,0.2); border-radius: 50%; color: white;
    display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10;
  }

  .modal-banner { height: 140px; background-size: cover; background-position: center; position: relative; display: flex; align-items: flex-end; padding: 20px; }
  .modal-quote { color: white; font-style: italic; font-size: 0.9rem; position: relative; z-index: 2; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }

  .modal-content { padding: 20px; }
  .info-row { display: flex; gap: 10px; margin: 20px 0; }
  .info-item { flex: 1; background: var(--bg); padding: 10px; border-radius: 8px; border: 1px solid var(--border); font-size: 0.85rem; }
  
  .rating-stars { display: flex; gap: 8px; justify-content: center; margin: 20px 0; }
  .star { font-size: 1.5rem; color: var(--border); cursor: pointer; transition: 0.2s; background: none; border: none; }
  .star:hover { color: #fbbf24; transform: scale(1.2); }

  @media (min-width: 768px) {
    .subtitle { display: block; }
  }
</style>
</head>
<body>

<div class="app-wrapper">
    <header>
        <div class="brand">
            <svg viewBox="0 0 100 100" fill="none"><defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="#1a73e8"/><stop offset="1" stop-color="#6ce0ff"/></linearGradient></defs><path d="M50 6 L88 20 V50 C88 74 50 94 50 94 C50 94 12 74 12 50 V20 Z" fill="url(#g)"/><circle cx="50" cy="44" r="14" stroke="white" stroke-width="5" fill="none"/></svg>
            <h1>Fair Discovery</h1>
            <div class="subtitle" data-i18n="subtitle">The decentralized, AI-ranked directory.</div>
        </div>
        <div class="controls">
            <button class="btn" onclick="openJoin()">üöÄ <span data-i18n="join">Join</span></button>
            <select class="lang-select" onchange="setLang(this.value)">
                <option value="en">üá∫üá∏ EN</option>
                <option value="es">üá™üá∏ ES</option>
                <option value="fr">üá´üá∑ FR</option>
            </select>
            <button class="btn-ghost" onclick="toggleTheme()">üåì</button>
        </div>
    </header>

    <div class="filters">
        <div class="search-box">
            <input type="text" id="searchInput" data-i18n-ph="search_ph" placeholder="Search services, shops...">
        </div>
        
        <select id="catFilter" class="select-box" onchange="filter()">
            <option value="all" data-i18n="cat_all">All Categories</option>
            <option value="Auto" data-i18n="cat_auto">üöó Auto</option>
            <option value="Tech" data-i18n="cat_tech">üíª Tech</option>
            <option value="Health" data-i18n="cat_health">üè• Health</option>
            <option value="Service" data-i18n="cat_service">üõ†Ô∏è Services</option>
            <option value="Retail" data-i18n="cat_retail">üõçÔ∏è Retail</option>
            <option value="Artists" data-i18n="cat_artists">üé® Artists</option>
        </select>

        <select id="locFilter" class="select-box" onchange="filter()">
            <option value="all" data-i18n="loc_global">üåç Global</option>
        </select>
    </div>

    <div class="stats">
        <span id="countLabel">Loading...</span>
        <span>Network Live</span>
    </div>

    <div id="grid" class="grid"></div>

    <footer>
        <p>Fair Discovery ¬© 2025 ‚Ä¢ Decentralized & Open Source</p>
        <div style="margin: 20px 0;">
            <a href="https://www.buymeacoffee.com/Prinymity" target="_blank" class="btn" style="background:#FFDD00; color:black; text-decoration:none;">‚òï Support the Dev</a>
        </div>
        <p style="font-size:0.8rem;">Powered by Gemini ‚Ä¢ GitHub ‚Ä¢ The Fair Collective ‚Ä¢ <a href="data.json" target="_blank">API</a></p>
    </footer>
</div>

<div id="modal" class="modal-overlay" onclick="closeModal()">
    <div class="modal-card" onclick="event.stopPropagation()">
        <div id="mBanner" class="modal-banner" style="background-image:url('https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?auto=format&fit=crop&w=600&q=80')">
            <div class="modal-close" onclick="closeModal()">‚úï</div>
            <div class="modal-quote" id="mQuote"></div>
        </div>
        <div class="modal-content">
            <div class="card-logo" id="mLogo">üåê</div>
            <h2 id="mTitle" style="margin-top:10px;">Business Name</h2>
            <p id="mMeta" style="color:var(--sub); margin:0;">Category</p>
            <p id="mDesc" style="line-height:1.6; margin:20px 0;">Description...</p>
            
            <div class="info-row">
                <div class="info-item"><strong>üìç Location</strong><br><span id="mLoc">City</span></div>
                <div class="info-item"><strong>üìû Contact</strong><br><span id="mPhone">Num</span></div>
            </div>
            
            <a id="mLink" href="#" target="_blank" class="btn" style="display:block; text-align:center; text-decoration:none;">Visit Website ‚Üó</a>
            
            <div style="text-align:center; margin-top:25px; padding-top:15px; border-top:1px solid var(--border);">
                <span style="font-size:0.8rem; font-weight:700; text-transform:uppercase; color:var(--sub);">Rate this Business</span>
                <div class="rating-stars">
                    <button class="star" onclick="rate(5)">‚òÖ</button>
                    <button class="star" onclick="rate(4)">‚òÖ</button>
                    <button class="star" onclick="rate(3)">‚òÖ</button>
                    <button class="star" onclick="rate(2)">‚òÖ</button>
                    <button class="star" onclick="rate(1)">‚òÖ</button>
                </div>
                <p style="font-size:0.75rem; color:var(--muted);">Anonymous voting via Google Forms</p>
            </div>
        </div>
    </div>
</div>

<script>
    // --- DATA & STATE ---
    const FEED = 'data.json';
    let allData = [], filtered = [];
    let currentBiz = "";
    
    // --- TRANSLATIONS ---
    const i18n = {
        en: { subtitle: "The decentralized, AI-ranked directory.", search_ph: "Search services...", join: "Join", cat_all: "All Categories", cat_auto: "üöó Auto", cat_tech: "üíª Tech", cat_service: "üõ†Ô∏è Services", loc_global: "üåç Global" },
        es: { subtitle: "El directorio descentralizado.", search_ph: "Buscar servicios...", join: "Unirse", cat_all: "Todas", cat_auto: "üöó Autos", cat_tech: "üíª Tec", cat_service: "üõ†Ô∏è Servicios", loc_global: "üåç Global" },
        fr: { subtitle: "L'annuaire d√©centralis√©.", search_ph: "Rechercher...", join: "Rejoindre", cat_all: "Toutes", cat_auto: "üöó Auto", cat_tech: "üíª Tech", cat_service: "üõ†Ô∏è Services", loc_global: "üåç Global" }
    };

    // --- THEME & LANG LOGIC ---
    function setLang(lang) {
        const t = i18n[lang] || i18n.en;
        document.querySelectorAll('[data-i18n]').forEach(e => e.innerText = t[e.dataset.i18n]);
        document.querySelectorAll('[data-i18n-ph]').forEach(e => e.placeholder = t[e.dataset.i18nPh]);
    }

    function toggleTheme() {
        const root = document.documentElement;
        const newTheme = root.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        root.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
    }
    
    // Load saved theme
    if(localStorage.getItem('theme') === 'light') document.documentElement.setAttribute('data-theme', 'light');

    // --- MAIN LOGIC ---
    async function init() {
        try {
            const res = await fetch(FEED + '?' + Date.now());
            const json = await res.json();
            
            const map = {};
            (json.pages || []).forEach(p => {
                try {
                    let d = new URL(p.url.startsWith('http')?p.url:'https://'+p.url).hostname;
                    if(!map[d]) map[d] = {
                        domain: d, url: p.url, score: 0, 
                        cat: p.category || "Service", 
                        desc: p.description || "Verified listing.",
                        wa: p.whatsapp, loc: p.location, deal: p.deal
                    };
                    map[d].score += p.score;
                } catch(e){}
            });
            allData = Object.values(map).sort((a,b) => b.score - a.score);
            
            // Populate Locations
            const locs = new Set();
            allData.forEach(i => {
                if(i.loc) {
                    locs.add(i.loc); // City, Country
                    if(i.loc.includes(',')) locs.add(i.loc.split(',')[1].trim()); // Country only
                }
            });
            const sel = document.getElementById('locFilter');
            [...locs].sort().forEach(l => {
                if(l) sel.innerHTML += `<option value="${l}">üìç ${l}</option>`;
            });

            filter();
        } catch(e) { 
            document.getElementById('grid').innerHTML = '<p style="text-align:center; color:var(--muted)">Loading network...</p>'; 
        }
    }

    function filter() {
        const cat = document.getElementById('catFilter').value;
        const loc = document.getElementById('locFilter').value;
        const term = document.getElementById('searchInput').value.toLowerCase();
        
        filtered = allData.filter(i => {
            const matchCat = cat === 'all' || i.cat === cat;
            let matchLoc = loc === 'all';
            if (!matchLoc && i.loc) matchLoc = i.loc.includes(loc);
            const text = (i.domain + i.desc + i.cat).toLowerCase();
            return matchCat && matchLoc && text.includes(term);
        });
        
        render();
    }

    function render() {
        const grid = document.getElementById('grid'); 
        grid.innerHTML = '';
        document.getElementById('countLabel').innerText = `Found ${filtered.length} sites`;
        
        filtered.forEach((item, idx) => {
            let flag = item.domain.endsWith('.za') ? 'üáøüá¶' : 'üåê';
            let dealHtml = item.deal ? `<div class="badge badge-deal">üî• ${item.deal}</div>` : '';
            let title = formatTitle(item.domain);
            
            // Image logic
            let bg = 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?auto=format&fit=crop&w=600&q=80'; // Default Service
            if(item.cat === 'Auto') bg = 'https://images.unsplash.com/photo-1486262715619-01b8c22973f5?auto=format&fit=crop&w=600&q=80';
            if(item.cat === 'Tech') bg = 'https://images.unsplash.com/photo-1518770660439-4636190af475?auto=format&fit=crop&w=600&q=80';
            if(item.cat === 'Health') bg = 'https://images.unsplash.com/photo-1505751172876-fa1923c5c528?auto=format&fit=crop&w=600&q=80';
            
            const card = document.createElement('div');
            card.className = 'card';
            card.onclick = () => openModal(idx);
            card.innerHTML = `
                <div class="card-banner" style="background-image:url('${bg}')"></div>
                <div class="card-body">
                    <div class="card-logo">${flag}</div>
                    <div class="card-badges">
                        <div class="badge badge-verified">‚úì Verified</div>
                        ${dealHtml}
                    </div>
                    <h3 class="card-title">${title}</h3>
                    <p class="card-meta">${item.domain.replace('.local','')}</p>
                    <p class="card-desc">${item.desc}</p>
                    <div class="card-footer">
                        <span>${item.cat}</span>
                        <span class="score">${(item.score>1000?(item.score/1000).toFixed(1)+'k':item.score)} <span style="font-size:0.7em;color:var(--muted)">AUTH</span></span>
                    </div>
                </div>
            `;
            grid.appendChild(card);
        });
    }

    function openModal(idx) {
        const i = filtered[idx];
        currentBiz = formatTitle(i.domain);
        
        document.getElementById('mTitle').innerText = currentBiz;
        document.getElementById('mDesc').innerText = i.desc;
        document.getElementById('mLoc').innerText = i.loc || 'Global';
        document.getElementById('mPhone').innerText = i.wa ? '+' + i.wa : 'N/A';
        
        // Smart Link
        let link = i.url;
        if(i.domain.includes('.local') && i.wa) link = `https://wa.me/${i.wa}`;
        document.getElementById('mLink').href = link;
        
        document.getElementById('modal').style.display = 'flex';
    }

    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    function openJoin() { window.open("https://github.com/fair-collective/fair-discovery/issues/new?title=Add%20Site", '_blank'); }

    function rate(stars) {
        const formId = "1FAIpQLSefrTrv68_G_l-6-6J41szCGqg_DcTxklCcWAPJ6e-_oV0k8A";
        const url = `https://docs.google.com/forms/d/e/${formId}/viewform?usp=pp_url&entry.1871531298=${encodeURIComponent(currentBiz)}&entry.741708013=${stars}`;
        window.open(url, '_blank');
    }

    function formatTitle(d) {
        if(d.includes("greyzone")) return "Grey Zone Auto Parts";
        if(d.includes("aolocksmith")) return "AO Locksmith";
        if(d.includes("autods")) return "Auto Digital Solutions";
        if(d.includes("bookkeepers")) return "Bookkeepers SA";
        if(d.includes("seritipbo")) return "Seriti PBO";
        if(d.includes("scouts")) return "Save Our Children";
        if(d.includes("jotto")) return "Jotto's Portfolio";
        if(d.includes("skyrope")) return "Sky Rope Specialist";
        if(d.includes("intpanel")) return "International Panel Shop";
        return d.split('.')[0].charAt(0).toUpperCase() + d.split('.')[0].slice(1);
    }

    document.getElementById('searchInput').addEventListener('input', filter);
    init();
</script>
</body>
</html>
