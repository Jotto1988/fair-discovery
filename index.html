<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
    <meta name="description" content="Fair Discovery: The decentralized, AI-ranked directory of authentic businesses." />
    <meta name="theme-color" content="#1a73e8" />
    <title>Fair Discovery Directory</title>

    <style>
        :root{
            --bg:#f7f8fb; --card-bg:#fff; --text:#1f2933; --text-sub:#6b7280;
            --border:#e6e9ef; --shadow:0 6px 18px rgba(16,24,40,0.06);
            --accent:#1a73e8; --muted:#9aa4b2;
        }
        [data-theme="dark"]{
            --bg:#0f1720; --card-bg:#0b1320; --text:#e6eef7; --text-sub:#98a2b3;
            --border:#12202b; --shadow:0 10px 30px rgba(2,6,23,0.6);
            --accent:#8ab4f8; --muted:#7b8aa2;
        }
        html,body{height:100%;margin:0;font-family:Inter, "Google Sans", Roboto, "Segoe UI", sans-serif;background:var(--bg);color:var(--text);}
        a{color:inherit}
        /* HEADER */
        header{
            padding:18px 20px;
            border-bottom:1px solid var(--border);
            position:relative;
            background:linear-gradient(180deg,var(--card-bg) 0%, transparent 100%);
        }
        .header-row{max-width:1200px;margin:0 auto;display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;}
        .brand{display:flex;gap:12px;align-items:center;}
        .brand svg{flex:0 0 44px}
        h1{font-size:1.4rem;margin:0;letter-spacing:-0.2px;display:flex;align-items:center;gap:10px}
        .subtitle{font-size:0.95rem;color:var(--text-sub);margin:6px 0 0;max-width:680px}
        .header-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
        .btn-control, .theme-toggle, .lang-select{background:var(--card-bg);border:1px solid var(--border);padding:8px 12px;border-radius:10px;cursor:pointer;font-size:0.9rem}
        .btn-control{display:inline-flex;gap:8px;align-items:center}
        .lang-select{appearance:none;padding-right:28px;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="%236b7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>');background-repeat:no-repeat;background-position:right 8px center}
        .theme-toggle{min-width:44px;text-align:center}
        /* FILTER BAR */
        .filters-wrap{max-width:1200px;margin:16px auto 0;padding:0 20px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center;}
        .search-wrapper{flex:1;min-width:220px;position:relative}
        .search-box{width:100%;padding:12px 44px 12px 16px;border-radius:12px;border:1px solid var(--border);background:var(--card-bg);box-sizing:border-box;outline:none;font-size:1rem}
        .geo-btn{position:absolute;right:10px;top:50%;transform:translateY(-50%);border:none;background:none;font-size:18px;cursor:pointer;opacity:.7}
        .custom-select{padding:11px 36px 11px 14px;border-radius:12px;border:1px solid var(--border);background:var(--card-bg) url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="%236b7280"><path d="M2 4l4 4 4-4"/></svg>') no-repeat right 12px center;cursor:pointer;min-width:150px;appearance:none}
        /* Cascading selects container */
        .location-filters{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
        /* GRID */
        .container{max-width:1200px;margin:20px auto;padding:0 20px 40px}
        .stats-bar{display:flex;justify-content:space-between;color:var(--text-sub);font-size:0.9rem;margin-bottom:14px;align-items:center}
        .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:18px}
        /* CARD */
        .card{background:var(--card-bg);border-radius:12px;overflow:hidden;border:1px solid var(--border);box-shadow:var(--shadow);cursor:pointer;display:flex;flex-direction:column;transition:transform .18s;min-height:220px}
        .card:hover{transform:translateY(-6px)}
        .card-banner{height:110px;background-size:cover;background-position:center;display:block;flex:0 0 110px;position:relative}
        .card-content{padding:12px 14px 14px;display:flex;flex-direction:column;gap:8px;flex:1}
        .brand-row{display:flex;align-items:center;justify-content:space-between;gap:8px}
        .card-logo{width:46px;height:46px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.6),rgba(0,0,0,0.04));display:flex;align-items:center;justify-content:center;font-size:1.2rem;border:1px solid var(--border)}
        .verified-tag{background:rgba(26,115,232,0.08);color:var(--accent);padding:4px 8px;border-radius:8px;font-weight:700;font-size:0.72rem}
        .card-title{font-size:1rem;margin:0;font-weight:700}
        .card-meta{font-size:0.85rem;color:var(--text-sub);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .card-desc{font-size:0.9rem;color:var(--text-sub);line-height:1.35;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
        .card-footer{display:flex;justify-content:space-between;align-items:center;margin-top:auto;padding-top:8px;border-top:1px solid var(--border);font-size:0.85rem}
        .score-val{font-weight:700;color:var(--accent)}
        .deal-badge{background:#fff8f0;color:#d0443e;padding:6px 8px;border-radius:8px;font-weight:700;border:1px solid #fde6e3;font-size:.78rem}
        /* MODAL */
        .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.55);display:none;align-items:center;justify-content:center;z-index:1200;padding:20px}
        .modal-card{background:var(--card-bg);width:100%;max-width:720px;border-radius:14px;overflow:hidden;box-shadow:0 40px 80px rgba(2,6,23,0.6);display:flex;flex-direction:column;max-height:92vh}
        .modal-banner{height:200px;background-size:cover;background-position:center;position:relative;display:flex;align-items:flex-end;padding:18px;color:white}
        .modal-banner::after{content:"";position:absolute;inset:0;background:linear-gradient(to top,rgba(0,0,0,0.6),transparent);}
        .modal-close{position:absolute;right:14px;top:14px;background:rgba(255,255,255,0.12);width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:1px solid rgba(255,255,255,0.15)}
        .modal-body{padding:18px;overflow:auto}
        .modal-header{display:flex;gap:14px;align-items:flex-end;margin-top:-32px;position:relative;z-index:3}
        .modal-logo{width:72px;height:72px;border-radius:12px;background:var(--card-bg);display:flex;align-items:center;justify-content:center;font-size:1.6rem;border:1px solid var(--border)}
        .info-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:14px 0}
        .info-box{background:var(--bg);padding:10px;border-radius:10px;border:1px solid var(--border);font-size:0.88rem}
        .info-label{font-size:0.72rem;text-transform:uppercase;color:var(--text-sub);font-weight:700;display:block;margin-bottom:6px}
        .btn-primary{background:var(--accent);color:white;border:none;padding:11px;border-radius:10px;width:100%;font-weight:700;cursor:pointer;text-align:center;text-decoration:none;display:inline-block}
        .rating-stars{display:flex;gap:8px;justify-content:center;margin-top:8px}
        .star{font-size:1.4rem;background:none;border:none;cursor:pointer}
        /* FOOTER */
        footer{padding:26px 20px;border-top:1px solid var(--border);text-align:center;color:var(--text-sub);margin-top:26px}
        /* small */
        @media (max-width:720px){
            .filters-wrap{padding:0 12px}
            .modal-banner{height:180px}
            .modal-header{margin-top:-28px}
            .card-banner{height:130px}
            .brand-row{gap:6px}
        }
    </style>
</head>
<body>

<header>
    <div class="header-row">
        <div style="display:flex;flex-direction:column;gap:6px;">
            <div style="display:flex;align-items:center;gap:12px;">
                <div class="brand">
                    <svg width="44" height="44" viewBox="0 0 100 100" fill="none" aria-hidden="true">
                        <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#1a73e8"/><stop offset="1" stop-color="#8ab4f8"/></linearGradient></defs>
                        <path d="M50 6 L90 20 V50 C90 75 50 94 50 94 C50 94 10 75 10 50 V20 Z" fill="url(#g)"/>
                        <circle cx="50" cy="45" r="15" stroke="white" stroke-width="5" fill="none"/>
                        <line x1="60" y1="54" x2="74" y2="68" stroke="white" stroke-width="5" stroke-linecap="round"/>
                    </svg>
                    <div>
                        <h1>Fair Discovery</h1>
                        <div class="subtitle" data-i18n="subtitle">The directory ranked by real humans, not bots.</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="header-controls" role="toolbar" aria-label="header controls">
            <button class="btn-control" onclick="openJoin()">üöÄ Join</button>
            <button id="installBtn" class="btn-control" onclick="installPWA()" style="display:none">üì≤ Install</button>
            <select class="lang-select" onchange="changeLanguage(this.value)" aria-label="language">
                <option value="en">üá∫üá∏ EN</option>
                <option value="es">üá™üá∏ ES</option>
                <option value="fr">üá´üá∑ FR</option>
            </select>
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">üåô</button>
        </div>
    </div>

    <div class="filters-wrap" aria-hidden="false">
        <div class="search-wrapper" style="flex:1 1 420px;">
            <input id="searchInput" class="search-box" placeholder="Search businesses, names or descriptions..." />
            <button class="geo-btn" onclick="geoFindMe()" title="Use my location">üìç</button>
        </div>

        <!-- Categories -->
        <select id="catFilter" class="custom-select" onchange="filter()" aria-label="Category">
            <option value="all">All Categories</option>
            <option value="Auto">üöó Auto</option>
            <option value="Tech">üíª Tech</option>
            <option value="Health">üè• Health</option>
            <option value="Service">üõ† Services</option>
            <option value="Retail">üõç Retail</option>
            <option value="Artists">üé® Artists</option>
            <option value="Real Estate">üè† Property</option>
            <option value="Travel">‚úàÔ∏è Travel</option>
        </select>

        <!-- Cascading location filters -->
        <div class="location-filters" style="align-items:center;">
            <select id="countrySelect" class="custom-select" onchange="onCountryChange()" aria-label="Country">
                <option value="all">üåç All countries</option>
            </select>
            <select id="stateSelect" class="custom-select" onchange="onStateChange()" aria-label="State / Province" style="display:none">
                <option value="all">‚Äî State / Province ‚Äî</option>
            </select>
            <select id="citySelect" class="custom-select" onchange="filter()" aria-label="City" style="display:none">
                <option value="all">‚Äî City ‚Äî</option>
            </select>
        </div>
    </div>
</header>

<main class="container">
    <div class="stats-bar">
        <span id="countLabel">Loading‚Ä¶</span>
        <div style="display:flex;gap:12px;align-items:center"><span>Network Live</span></div>
    </div>

    <div id="grid" class="grid" aria-live="polite"></div>

    <div id="pagination" style="margin-top:18px;display:flex;gap:8px;flex-wrap:wrap;align-items:center"></div>
</main>

<footer>
    <p>Fair Discovery &copy; 2025 ‚Ä¢ Decentralized & Open Source</p>
    <div style="margin:12px 0;"><a href="https://www.buymeacoffee.com/Prinymity" target="_blank" style="background:#FFDD00;color:black;padding:8px 14px;border-radius:20px;font-weight:700;text-decoration:none">‚òï Support the Dev</a></div>
    <p style="opacity:.6">Powered by Gemini ‚Ä¢ GitHub ‚Ä¢ The Fair Collective</p>
</footer>

<!-- Profile modal -->
<div id="profileModal" class="modal-backdrop" onclick="closeModal('profile')">
    <div class="modal-card" role="dialog" aria-modal="true" onclick="event.stopPropagation()">
        <div id="mBanner" class="modal-banner" style="background-image:linear-gradient(180deg,rgba(0,0,0,0.35),transparent), url('');">
            <div class="modal-close" onclick="closeModal('profile')">‚úï</div>
            <div style="position:relative;z-index:3;">
                <div id="mQuote" style="font-style:italic;font-size:0.95rem;max-width:78%"></div>
            </div>
        </div>

        <div class="modal-body">
            <div class="modal-header">
                <div class="modal-logo" id="mLogo">üåê</div>
                <div>
                    <h2 id="mTitle" style="margin:0">Business Name</h2>
                    <div id="mMeta" style="color:var(--text-sub);margin-top:6px">Category ‚Ä¢ Loc</div>
                </div>
            </div>

            <p id="mDesc" style="color:var(--text);line-height:1.6;margin-top:10px">Description</p>

            <div class="info-grid">
                <div class="info-box">
                    <span class="info-label">üìç Location</span>
                    <div id="mLoc">City</div>
                </div>
                <div class="info-box">
                    <span class="info-label">üìû Contact</span>
                    <div id="mPhone">Number</div>
                </div>
            </div>

            <a id="mLink" href="#" target="_blank" class="btn-primary" style="display:inline-block;margin-bottom:8px">Visit Website ‚Üó</a>

            <div style="margin-top:14px;text-align:center;border-top:1px solid var(--border);padding-top:14px">
                <span class="info-label">Rate this Business</span>
                <div class="rating-stars">
                    <button class="star" onclick="rate(1)">‚òÖ</button>
                    <button class="star" onclick="rate(2)">‚òÖ</button>
                    <button class="star" onclick="rate(3)">‚òÖ</button>
                    <button class="star" onclick="rate(4)">‚òÖ</button>
                    <button class="star" onclick="rate(5)">‚òÖ</button>
                </div>
                <p style="font-size:0.82rem;color:var(--text-sub);margin-top:8px">Rate anonymously via Google Forms</p>
            </div>
        </div>
    </div>
</div>

<!-- Join modal -->
<div id="joinModal" class="modal-backdrop" onclick="closeModal('join')">
    <div class="modal-card" onclick="event.stopPropagation()">
        <div class="modal-body" style="text-align:center">
            <div class="modal-close" onclick="closeModal('join')" style="background:#ddd;color:#333">‚úï</div>
            <h2 style="margin-top:0">üöÄ How to Join</h2>
            <p>1. Download the <code>fair-discovery</code> folder from GitHub.<br>2. Upload to your site root.<br>3. Submit your URL below.</p>
            <a href="https://github.com/fair-collective/fair-discovery/issues/new?title=Add%20Site" target="_blank" class="btn-primary">Submit Site</a>
            <div style="margin-top:12px;text-align:left">
                <p><strong>Manual entry (if robot blocked)</strong></p>
                <pre style="background:#111;color:#fff;padding:10px;border-radius:8px;overflow:auto">{ "url":"https://your-site.com/","score":100,"category":"Service","description":"About","whatsapp":"27000","location":"City, State, Country" }</pre>
            </div>
        </div>
    </div>
</div>

<script>
/* ------------- CONFIG & STATE ------------- */
const FEED = 'data.json';
let allData = [], filtered = [];
let currentBiz = '';
let limit = 12, currentPage = 1;

/* Quotes (no psychology/mental-health/dating) */
const quotes = [
    "Quality means doing it right when no one is looking.",
    "Truth is the only safe ground.",
    "Honesty is the first chapter of wisdom.",
    "Consistency builds credibility.",
    "Good business is built on clear promises delivered."
];

/* Images per category (Unsplash / royalty-free placeholders) */
const categoryImages = {
    'Auto': [
        'https://images.unsplash.com/photo-1502877338535-766e1452684a?auto=format&fit=crop&w=1200&q=80',
        'https://images.unsplash.com/photo-1525609004556-c46c7d6cf023?auto=format&fit=crop&w=1200&q=80'
    ],
    'Tech': [
        'https://images.unsplash.com/photo-1518770660439-4636190af475?auto=format&fit=crop&w=1200&q=80',
        'https://images.unsplash.com/photo-1519389950473-47ba0277781c?auto=format&fit=crop&w=1200&q=80'
    ],
    'Health': [
        'https://images.unsplash.com/photo-1580281657520-6d1b5d5f1b2f?auto=format&fit=crop&w=1200&q=80',
        'https://images.unsplash.com/photo-1582719478183-933a1aa3e197?auto=format&fit=crop&w=1200&q=80'
    ],
    'Service': [
        'https://images.unsplash.com/photo-1581091215367-6f5c4f3b5f56?auto=format&fit=crop&w=1200&q=80',
        'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?auto=format&fit=crop&w=1200&q=80'
    ],
    'Retail': [
        'https://images.unsplash.com/photo-1521334884684-d80222895322?auto=format&fit=crop&w=1200&q=80',
        'https://images.unsplash.com/photo-1475546762581-52d8e2b1d6da?auto=format&fit=crop&w=1200&q=80'
    ],
    'Artists': [
        'https://images.unsplash.com/photo-1504198266284-1659872e6590?auto=format&fit=crop&w=1200&q=80',
        'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1200&q=80'
    ],
    'Real Estate': [
        'https://images.unsplash.com/photo-1502673530728-f79b4cab31b1?auto=format&fit=crop&w=1200&q=80',
        'https://images.unsplash.com/photo-1572120360610-d971b9b0f7c6?auto=format&fit=crop&w=1200&q=80'
    ],
    'Travel': [
        'https://images.unsplash.com/photo-1470770903676-69b98201ea1c?auto=format&fit=crop&w=1200&q=80',
        'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=1200&q=80'
    ],
    'default': [
        'https://images.unsplash.com/photo-1521791136064-7986c2920216?auto=format&fit=crop&w=1200&q=80'
    ]
};

/* ------------- UTILITIES ------------- */
function pickImageForCategory(cat){
    const arr = categoryImages[cat] || categoryImages['default'];
    return arr[Math.floor(Math.random() * arr.length)];
}
function dailyQuote(){
    // deterministic by date: same quote for all users per day
    const d = new Date();
    const seed = Math.floor(new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime() / (1000*60*60*24));
    return quotes[seed % quotes.length];
}

/* PWA prompt */
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; document.getElementById('installBtn').style.display = 'inline-flex'; });
function installPWA(){ if(deferredPrompt){ deferredPrompt.prompt(); deferredPrompt = null; } }
if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js').catch(()=>{}); }

/* ------------- DATA LOADING & PROCESSING ------------- */
async function init(){
    try{
        const res = await fetch(FEED + '?_=' + Date.now());
        const json = await res.json();
        processData(json.pages || []);
    }catch(e){
        console.error(e);
        document.getElementById('grid').innerHTML = '<p style="text-align:center;color:var(--text-sub)">Could not load feed.</p>';
    }
}

function processData(pages){
    const map = {};
    pages.forEach(p => {
        try{
            // normalize domain
            let url = p.url || '';
            if(!url) return;
            if(!url.startsWith('http')) url = (url.startsWith('//') ? 'https:' + url : 'https://' + url);
            const hostname = new URL(url).hostname;
            const key = hostname;
            if(!map[key]) map[key] = {
                domain: hostname,
                url: p.url,
                score: 0,
                cat: p.category || inferCat(hostname),
                desc: p.description || "Verified listing.",
                wa: p.whatsapp || '',
                loc: p.location || 'Global'
            };
            map[key].score += (Number(p.score) || 0);
            if(p.category) map[key].cat = p.category;
            if(p.description) map[key].desc = p.description;
        }catch(err){}
    });

    allData = Object.values(map).sort((a,b)=> (b.score||0) - (a.score||0));

    // Build country/state/city sets
    buildLocationIndex();

    // finalize UI
    filter();
}

/* Infer category from domain if absent */
function inferCat(d){
    d = d.toLowerCase();
    if(d.includes('auto')||d.includes('panel')||d.includes('garage')) return 'Auto';
    if(d.includes('tech')||d.includes('app')||d.includes('cloud')) return 'Tech';
    if(d.includes('health')||d.includes('clinic')||d.includes('medical')) return 'Health';
    if(d.includes('art')||d.includes('gallery')||d.includes('studio')) return 'Artists';
    if(d.includes('shop')||d.includes('store')||d.includes('boutique')) return 'Retail';
    if(d.includes('property')||d.includes('estate')||d.includes('realtor')) return 'Real Estate';
    if(d.includes('travel')||d.includes('tour')||d.includes('trip')) return 'Travel';
    return 'Service';
}

/* Format title from domain */
function formatTitle(d){
    try{
        const host = d.split('.')[0];
        return host.charAt(0).toUpperCase() + host.slice(1);
    }catch(e){ return d; }
}

/* ------------- LOCATION INDEX / CASCADING ------------- */
const locIndex = {}; // country -> state -> Set(cities)

function buildLocationIndex(){
    // Example location parsing rules:
    // - if i.loc is "City, State, Country" or "City, Country" or "Country"
    locIndex.clear;
    Object.values(allData).forEach(i=>{
        const raw = i.loc || '';
        const parts = raw.split(',').map(s=>s.trim()).filter(Boolean);
        if(parts.length===0) {
            addToLoc('Global', 'All', 'All');
        } else if(parts.length===1) {
            addToLoc(parts[0], 'All', 'All');
        } else if(parts.length===2) {
            addToLoc(parts[1], parts[0], 'All'); // Country, City -> parts[1]=country, parts[0]=city
        } else {
            const city = parts[0], state = parts[1], country = parts.slice(2).join(', ');
            addToLoc(country, state, city);
        }
    });

    populateCountrySelect();
}

function addToLoc(country, state='All', city='All'){
    if(!country) country = 'Global';
    if(!locIndex[country]) locIndex[country] = {};
    if(!state) state = 'All';
    if(!locIndex[country][state]) locIndex[country][state] = new Set();
    if(city) locIndex[country][state].add(city);
}

function populateCountrySelect(){
    const sel = document.getElementById('countrySelect');
    sel.innerHTML = '<option value="all">üåç All countries</option>';
    const countries = Object.keys(locIndex).sort((a,b)=> a.localeCompare(b));
    countries.forEach(c => {
        if(c && c.toLowerCase() !== 'all') sel.innerHTML += `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`;
    });
    // reset state/city selects
    document.getElementById('stateSelect').style.display='none';
    document.getElementById('citySelect').style.display='none';
}

/* Called when country changes */
function onCountryChange(){
    const country = document.getElementById('countrySelect').value;
    const stateSel = document.getElementById('stateSelect');
    const citySel = document.getElementById('citySelect');
    stateSel.innerHTML = '<option value="all">‚Äî State / Province ‚Äî</option>';
    citySel.innerHTML = '<option value="all">‚Äî City ‚Äî</option>';
    citySel.style.display = 'none';
    if(country === 'all') { stateSel.style.display='none'; filter(); return; }

    const states = Object.keys(locIndex[country] || {}).sort((a,b)=> a.localeCompare(b));
    states.forEach(s => {
        stateSel.innerHTML += `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`;
    });
    stateSel.style.display = 'inline-block';
    filter();
}

function onStateChange(){
    const country = document.getElementById('countrySelect').value;
    const state = document.getElementById('stateSelect').value;
    const citySel = document.getElementById('citySelect');
    citySel.innerHTML = '<option value="all">‚Äî City ‚Äî</option>';
    if(state === 'all' || !country){ citySel.style.display = 'none'; filter(); return; }
    const cities = Array.from(locIndex[country][state] || []).sort((a,b)=> a.localeCompare(b));
    cities.forEach(c => citySel.innerHTML += `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`);
    citySel.style.display = 'inline-block';
    filter();
}

/* ------------- FILTERING & RENDER ------------- */
function filter(){
    const cat = document.getElementById('catFilter').value;
    const term = (document.getElementById('searchInput').value || '').toLowerCase();
    const country = document.getElementById('countrySelect').value || 'all';
    const state = (document.getElementById('stateSelect').value || 'all');
    const city = (document.getElementById('citySelect').value || 'all');

    filtered = allData.filter(i=>{
        // category match
        const matchCat = cat === 'all' || (i.cat === cat);
        // text match
        const text = (i.domain + ' ' + (i.desc||'') + ' ' + (i.cat||'') + ' ' + (i.loc||'') + ' ' + formatTitle(i.domain)).toLowerCase();
        const matchText = text.includes(term);
        // location match: parse i.loc into parts
        let matchLoc = true;
        if(country !== 'all'){
            // check if i.loc includes country
            matchLoc = (i.loc && i.loc.toLowerCase().includes(country.toLowerCase()));
            if(matchLoc && state !== 'all') matchLoc = i.loc.toLowerCase().includes(state.toLowerCase());
            if(matchLoc && city !== 'all') matchLoc = i.loc.toLowerCase().includes(city.toLowerCase());
        }
        return matchCat && matchText && matchLoc;
    });

    // reset page
    currentPage = 1;
    render();
}

function render(){
    const grid = document.getElementById('grid');
    grid.innerHTML = '';
    document.getElementById('countLabel').innerText = `Found ${filtered.length} sites`;

    // pagination slice
    const start = (currentPage - 1) * limit;
    const pageItems = filtered.slice(start, start + limit);

    pageItems.forEach((item, idx)=>{
        const flag = item.domain.endsWith('.za') ? 'üáøüá¶' : 'üåê';
        const banner = pickImageForCategory(item.cat);
        const dealBadge = item.deal ? `<div class="deal-badge">üî• ${escapeHtml(item.deal)}</div>` : '';
        const card = document.createElement('article');
        card.className = 'card';
        card.setAttribute('role','button');
        card.tabIndex = 0;
        card.addEventListener('click', ()=> openModal(start + idx));
        card.addEventListener('keypress', (e)=> { if(e.key === 'Enter') openModal(start + idx); });

        card.innerHTML = `
            <div class="card-banner" style="background-image: linear-gradient(180deg, rgba(0,0,0,0.06), rgba(0,0,0,0.06)), url('${banner}')" aria-hidden="true"></div>
            <div class="card-content">
                <div class="brand-row">
                    <div style="display:flex;gap:10px;align-items:center">
                        <div class="card-logo">${flag}</div>
                        <div>
                            <div class="card-title">${escapeHtml(formatTitle(item.domain))}</div>
                            <div class="card-meta">${escapeHtml(item.domain.replace('.local',''))}</div>
                        </div>
                    </div>
                    <div style="display:flex;flex-direction:column;align-items:flex-end">
                        <div class="verified-tag">‚úì Verified</div>
                        ${dealBadge}
                    </div>
                </div>
                <div class="card-desc">${escapeHtml(item.desc)}</div>
                <div class="card-footer">
                    <span style="font-weight:600">${escapeHtml(item.cat)}</span>
                    <div style="display:flex;gap:8px;align-items:center">
                        <div class="score-val">${(item.score>1000? (item.score/1000).toFixed(1)+'k' : item.score||0)}</div>
                        <div style="font-size:0.85rem;color:var(--muted)">Auth</div>
                    </div>
                </div>
            </div>
        `;
        grid.appendChild(card);
    });

    renderPag();
}

/* ------------- MODAL ------------- */
function openModal(globalIdx){
    const i = filtered[globalIdx];
    if(!i) return;
    currentBiz = formatTitle(i.domain);
    const banner = document.getElementById('mBanner');
    const img = pickImageForCategory(i.cat);
    banner.style.backgroundImage = `linear-gradient(180deg, rgba(0,0,0,0.45), transparent), url('${img}')`;
    document.getElementById('mQuote').innerText = dailyQuote();
    document.getElementById('mTitle').innerText = currentBiz;
    document.getElementById('mMeta').innerText = `${i.cat} ‚Ä¢ ${i.loc}`;
    document.getElementById('mDesc').innerText = i.desc || 'Verified listing.';
    document.getElementById('mLoc').innerText = i.loc || 'Global';
    document.getElementById('mPhone').innerText = i.wa ? ('+' + i.wa) : 'N/A';
    document.getElementById('mLogo').innerText = i.domain.endsWith('.za') ? 'üáøüá¶' : 'üåê';
    const link = i.url || (i.wa ? `https://wa.me/${i.wa}` : '#');
    const mLink = document.getElementById('mLink');
    mLink.href = link;
    mLink.target = '_blank';
    document.getElementById('profileModal').style.display = 'flex';
}

function closeModal(id){
    if(id === 'join') document.getElementById('joinModal').style.display = 'none';
    else document.getElementById('profileModal').style.display = 'none';
}

/* ------------- PAGINATION ------------- */
function renderPag(){
    const el = document.getElementById('pagination');
    el.innerHTML = '';
    const pages = Math.ceil(filtered.length / limit) || 1;
    if(pages <= 1) return;
    for(let i = 1; i <= pages; i++){
        const btn = document.createElement('button');
        btn.className = 'custom-select';
        btn.style.padding = '8px 10px';
        btn.style.minWidth = '40px';
        btn.textContent = i;
        btn.onclick = (()=> {
            currentPage = i;
            window.scrollTo({top:0,behavior:'smooth'});
            render();
        });
        if(i === currentPage){
            btn.style.border = `1px solid ${getComputedStyle(document.documentElement).getPropertyValue('--accent')}`;
            btn.style.fontWeight = '700';
        }
        el.appendChild(btn);
    }
}

/* ------------- RATING ------------- */
function rate(stars){
    // fixed form variable
    const formId = "1FAIpQLSefrTrv68_G_l-6-6J41szCGqg_DcTxklCcWAPJ6e-_oV0k8A";
    const entryBizField = encodeURIComponent(currentBiz || '');
    const url = `https://docs.google.com/forms/d/e/${formId}/viewform?usp=pp_url&entry.1871531298=${entryBizField}&entry.741708013=${stars}`;
    window.open(url, '_blank');
}

/* ------------- HELPERS & MISC ------------- */
function escapeHtml(s = '') {
    return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); });
}
function geoFindMe(){ alert("Location search is not enabled in this demo."); }
function openJoin(){ document.getElementById('joinModal').style.display = 'flex'; }
function changeLanguage(v){ alert("Language support will be available in V2."); }
function toggleTheme(){ const cur = document.body.getAttribute('data-theme'); document.body.setAttribute('data-theme', cur === 'dark' ? '' : 'dark'); }

/* ------------- Initialize DOM wiring ------------- */
document.getElementById('searchInput').addEventListener('input', ()=> filter());

/* Start */
init();
</script>

</body>
</html>
