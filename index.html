<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Fair Discovery: The decentralized, AI-ranked directory. Free, open, and transparent.">
    <title>Fair Discovery Directory</title>
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%231a73e8'/%3E%3Ccircle cx='42' cy='42' r='24' stroke='white' stroke-width='12' fill='none'/%3E%3Cline x1='60' y1='60' x2='85' y2='85' stroke='white' stroke-width='12' stroke-linecap='round'/%3E%3C/svg%3E">
    
    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --primary: #1a73e8; --bg: #f0f2f5; --card-bg: #ffffff;
            --text: #1f1f1f; --text-sub: #5f6368; --border: #dadce0;
            --success: #1e8e3e; --badge-bg: #e8f0fe;
        }

        [data-theme="dark"] {
            --primary: #8ab4f8; --bg: #202124; --card-bg: #303134;
            --text: #e8eaed; --text-sub: #9aa0a6; --border: #3c4043;
            --success: #81c995; --badge-bg: #3c4043;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; display: flex; flex-direction: column; min-height: 100vh; }

        /* HEADER */
        header { background: var(--card-bg); padding: 30px 20px 20px; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .header-top { display: flex; justify-content: space-between; align-items: center; max-width: 1000px; margin: 0 auto 20px; flex-wrap: wrap; gap: 10px; }
        
        h1 { margin: 0; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        h1 span { font-weight: 300; opacity: 0.8; }
        
        .theme-toggle { background: none; border: 1px solid var(--border); color: var(--text); padding: 6px 12px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; }

        /* SEARCH & CATEGORIES */
        .search-container { max-width: 600px; margin: 0 auto; }
        input {
            width: 100%; padding: 12px 20px; border-radius: 50px; border: 1px solid var(--border);
            background: var(--bg); color: var(--text); font-size: 1rem; outline: none; box-sizing: border-box;
            transition: all 0.2s;
        }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(26,115,232,0.1); }

        .categories { 
            display: flex; gap: 10px; overflow-x: auto; padding: 15px 0 5px; 
            max-width: 1000px; margin: 0 auto; scrollbar-width: none; 
        }
        .cat-pill {
            white-space: nowrap; padding: 6px 14px; background: var(--card-bg); 
            border: 1px solid var(--border); border-radius: 16px; font-size: 0.9rem; 
            cursor: pointer; color: var(--text-sub); transition: 0.2s;
        }
        .cat-pill:hover, .cat-pill.active { background: var(--badge-bg); color: var(--primary); border-color: var(--primary); }

        /* GRID LAYOUT */
        .container { max-width: 1000px; margin: 20px auto; padding: 0 20px; flex: 1; width: 100%; box-sizing: border-box; }
        .stats-bar { display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-sub); margin-bottom: 15px; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        
        /* CARD STYLING */
        .card {
            background: var(--card-bg); border-radius: 12px; padding: 20px;
            border: 1px solid var(--border); display: flex; flex-direction: column; gap: 12px;
            transition: transform 0.2s, box-shadow 0.2s; position: relative; overflow: hidden;
        }
        .card:hover { transform: translateY(-3px); box-shadow: 0 8px 24px rgba(0,0,0,0.08); border-color: var(--primary); }

        .card-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .card-brand { display: flex; align-items: center; gap: 10px; flex: 1; min-width: 0; } /* min-width fix for text overflow */
        .card-logo { width: 40px; height: 40px; background: var(--bg); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }
        
        .card-text { min-width: 0; flex: 1; }
        .card-title { font-size: 1.1rem; font-weight: 600; color: var(--text); text-decoration: none; margin: 0; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
        .card-title:hover { text-decoration: underline; }
        .card-domain { font-size: 0.8rem; color: var(--text-sub); display: block; margin-top: 2px; }
        
        .verified-badge { font-size: 0.75rem; color: var(--success); background: rgba(30,142,62,0.1); padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 4px; }

        .card-desc { font-size: 0.9rem; color: var(--text-sub); line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        .card-footer { margin-top: auto; padding-top: 15px; border-top: 1px solid var(--bg); display: flex; justify-content: space-between; align-items: center; }
        
        .score-box { text-align: right; }
        .score-val { font-weight: 700; color: var(--primary); font-size: 1.2rem; }
        .score-lbl { font-size: 0.7rem; color: var(--text-sub); text-transform: uppercase; }

        .actions { display: flex; gap: 8px; }
        .btn-icon { width: 32px; height: 32px; border-radius: 50%; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; text-decoration: none; color: var(--text-sub); transition: 0.2s; }
        .btn-icon:hover { background: var(--bg); color: var(--primary); border-color: var(--primary); }
        .btn-whatsapp { color: #25D366; border-color: #25D366; }
        .btn-whatsapp:hover { background: #25D366; color: white; }

        /* PAGINATION & FOOTER */
        .pagination { display: flex; justify-content: center; gap: 5px; margin: 40px 0; }
        .page-btn { background: var(--card-bg); border: 1px solid var(--border); padding: 8px 12px; border-radius: 6px; cursor: pointer; color: var(--text); }
        .page-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        footer { text-align: center; padding: 40px 20px; color: var(--text-sub); font-size: 0.9rem; border-top: 1px solid var(--border); background: var(--card-bg); }
        .api-link { color: var(--primary); font-weight: 600; text-decoration: none; }
        
        @media (max-width: 600px) {
            .grid { grid-template-columns: 1fr; }
            .header-top { flex-direction: column; align-items: flex-start; }
            .theme-toggle { position: absolute; top: 30px; right: 20px; }
            .categories { padding-bottom: 10px; }
        }
    </style>
</head>
<body>

<header>
    <div class="header-top">
        <h1>Fair <span>Discovery</span></h1>
        <button class="theme-toggle" onclick="toggleTheme()">üåô Theme</button>
    </div>

    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Try 'auto cape town' or 'tech services'...">
    </div>

    <div class="categories" id="catFilters">
        <div class="cat-pill active" onclick="filterCat('all')">All</div>
        <div class="cat-pill" onclick="filterCat('Auto')">üöó Auto</div>
        <div class="cat-pill" onclick="filterCat('Tech')">üíª Tech</div>
        <div class="cat-pill" onclick="filterCat('Health')">üè• Health</div>
        <div class="cat-pill" onclick="filterCat('Service')">üõ†Ô∏è Services</div>
        <div class="cat-pill" onclick="filterCat('Retail')">üõçÔ∏è Retail</div>
    </div>
</header>

<div class="container">
    <div class="stats-bar">
        <span id="statsLabel">Loading...</span>
        <span>Global Feed</span>
    </div>
    
    <div id="resultsGrid" class="grid"></div>
    <div class="pagination" id="paginationControls"></div>
</div>

<footer>
    <p>Fair Discovery is a decentralized, human-first directory.</p>
    <p>üöÄ Developers: <a href="data.json" target="_blank" class="api-link">Get the JSON API</a></p>
    <br>
    <a href="https://www.buymeacoffee.com/Prinymity" target="_blank" style="text-decoration:none;">
        <span style="background:#FFDD00; color:black; padding:8px 16px; border-radius:6px; font-weight:bold;">‚òï Support the Dev</span>
    </a>
</footer>

<script>
    const FEED_URL = 'data.json'; 
    let allData = [];
    let filteredData = [];
    let currentPage = 1;
    const limit = 12;
    let currentCategory = 'all';

    function toggleTheme() {
        const body = document.body;
        const isDark = body.getAttribute('data-theme') === 'dark';
        body.setAttribute('data-theme', isDark ? 'light' : 'dark');
    }

    async function init() {
        try {
            const res = await fetch(FEED_URL + '?' + Date.now());
            const json = await res.json();
            
            // GROUPING: Combine pages into Domains
            const domainMap = {};
            (json.pages || []).forEach(page => {
                try {
                    const urlStr = page.url.startsWith('http') ? page.url : 'https://' + page.url;
                    const urlObj = new URL(urlStr);
                    const domain = urlObj.hostname;
                    
                    if (!domainMap[domain]) {
                        domainMap[domain] = {
                            domain: domain,
                            fullUrl: urlObj.origin,
                            totalScore: 0,
                            pageCount: 0,
                            // READ NEW FIELDS HERE
                            category: page.category || inferCategory(domain), 
                            description: page.description || "Verified decentralized listing.",
                            whatsapp: page.whatsapp || null,
                            location: page.location || inferLocation(domain)
                        };
                    }
                    // Aggregate Score
                    domainMap[domain].totalScore += page.score;
                    domainMap[domain].pageCount++;
                    
                    // If a sub-page has better metadata, upgrade the domain record
                    if (page.category && !domainMap[domain].category) domainMap[domain].category = page.category;
                    if (page.description && domainMap[domain].description.startsWith("Verified")) domainMap[domain].description = page.description;
                    
                } catch(e){}
            });

            allData = Object.values(domainMap).sort((a, b) => b.totalScore - a.totalScore);
            applyFilters();
        } catch (err) {
            document.getElementById('resultsGrid').innerHTML = `<p style="text-align:center">Database Building... Check back soon.</p>`;
        }
    }

    // Fallback Logic
    function inferCategory(domain) {
        const d = domain.toLowerCase();
        if (d.includes('panel') || d.includes('auto') || d.includes('motor')) return 'Auto';
        if (d.includes('tech') || d.includes('soft') || d.includes('app')) return 'Tech';
        if (d.includes('health') || d.includes('med')) return 'Health';
        return 'Service';
    }
    
    function inferLocation(domain) {
         if (domain.endsWith('.za')) return 'South Africa';
         return 'Global';
    }

    // SMART FILTER LOGIC
    function filterCat(cat) {
        currentCategory = cat;
        document.querySelectorAll('.cat-pill').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
        applyFilters();
    }

    function applyFilters() {
        const rawInput = document.getElementById('searchInput').value.toLowerCase();
        // Split input into words: "salon cape town" -> ["salon", "cape", "town"]
        const searchTokens = rawInput.split(' ').filter(token => token.length > 0);
        
        filteredData = allData.filter(item => {
            // Check Category Match
            const matchesCat = currentCategory === 'all' || item.category === currentCategory;
            
            // Check Search Match (ALL tokens must exist in the record)
            const searchableText = `${item.domain} ${item.description} ${item.category} ${item.location}`.toLowerCase();
            const matchesSearch = searchTokens.every(token => searchableText.includes(token));
            
            return matchesCat && matchesSearch;
        });

        currentPage = 1;
        render();
    }

    function render() {
        const grid = document.getElementById('resultsGrid');
        grid.innerHTML = '';
        document.getElementById('statsLabel').innerText = `Found ${filteredData.length} sites`;

        const totalPages = Math.ceil(filteredData.length / limit);
        const start = (currentPage - 1) * limit;
        const pageItems = filteredData.slice(start, start + limit);

        if (pageItems.length === 0) {
            grid.innerHTML = '<p style="text-align:center; grid-column:1/-1;">No results found matching all terms.</p>';
            return;
        }

        pageItems.forEach(item => {
            let flag = 'üåê';
            if (item.domain.endsWith('.za')) flag = 'üáøüá¶';
            if (item.domain.endsWith('.uk')) flag = 'üá¨üáß';
            
            let actions = '';
            if (item.whatsapp) actions += `<a href="https://wa.me/${item.whatsapp}" target="_blank" class="btn-icon btn-whatsapp" title="WhatsApp">üí¨</a>`;
            actions += `<a href="${item.fullUrl}" target="_blank" class="btn-icon" title="Visit Site">‚Üó</a>`;

            const card = `
                <div class="card">
                    <div class="card-header">
                        <div class="card-brand">
                            <div class="card-logo">${flag}</div>
                            <div class="card-text">
                                <a href="${item.fullUrl}" target="_blank" class="card-title">${formatTitle(item.domain)}</a>
                                <span class="card-domain">${item.domain}</span>
                                <span class="verified-badge">‚úì Verified</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-desc">${item.description}</div>
                    
                    <div class="card-footer">
                        <div class="actions">${actions}</div>
                        <div class="score-box">
                            <div class="score-val">${formatScore(item.totalScore)}</div>
                            <div class="score-lbl">Authority</div>
                        </div>
                    </div>
                </div>
            `;
            grid.insertAdjacentHTML('beforeend', card);
        });

        renderPagination(totalPages);
    }

    function formatTitle(domain) {
        let t = domain.split('.')[1] || domain.split('.')[0]; 
        return t.charAt(0).toUpperCase() + t.slice(1);
    }

    function formatScore(num) {
        if (num > 1000000) return (num/1000000).toFixed(1) + 'M';
        if (num > 1000) return (num/1000).toFixed(1) + 'k';
        return num;
    }

    function renderPagination(totalPages) {
        const container = document.getElementById('paginationControls');
        container.innerHTML = '';
        if (totalPages <= 1) return;

        for (let i = 1; i <= totalPages; i++) {
            if (totalPages > 10 && Math.abs(currentPage - i) > 2 && i !== 1 && i !== totalPages) continue; 
            container.insertAdjacentHTML('beforeend', 
                `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`
            );
        }
    }

    function changePage(num) { currentPage = num; render(); window.scrollTo(0, 0); }

    document.getElementById('searchInput').addEventListener('input', applyFilters);
    init();
</script>

</body>
</html>
