<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Fair Discovery: The decentralized, AI-ranked directory of authentic businesses.">
    <title>Fair Discovery Directory</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%231a73e8'/%3E%3Ccircle cx='42' cy='42' r='24' stroke='white' stroke-width='12' fill='none'/%3E%3Cline x1='60' y1='60' x2='85' y2='85' stroke='white' stroke-width='12' stroke-linecap='round'/%3E%3C/svg%3E">
    <style>
        :root { --primary: #1a73e8; --bg: #f0f2f5; --card-bg: #ffffff; --text: #1f1f1f; --text-sub: #5f6368; --border: #dadce0; --success: #1e8e3e; --badge-bg: #e8f0fe; }
        [data-theme="dark"] { --primary: #8ab4f8; --bg: #202124; --card-bg: #303134; --text: #e8eaed; --text-sub: #9aa0a6; --border: #3c4043; --success: #81c995; --badge-bg: #3c4043; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; display: flex; flex-direction: column; min-height: 100vh; transition: background 0.3s; }
        header { background: linear-gradient(180deg, var(--card-bg) 0%, var(--bg) 100%); padding: 60px 20px 40px; border-bottom: 1px solid var(--border); position: relative; text-align: center; }
        .header-controls-right { position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; }
        .header-controls-left { position: absolute; top: 20px; left: 20px; }
        .btn-control, .lang-select, .theme-toggle { background: var(--card-bg); border: 1px solid var(--border); color: var(--text); padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; transition: 0.2s; outline: none; }
        .lang-select { -webkit-appearance: none; -moz-appearance: none; appearance: none; padding-right: 25px; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="%235f6368" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>'); background-repeat: no-repeat; background-position: right 8px center; }
        .btn-control:hover, .lang-select:hover, .theme-toggle:hover { background: var(--bg); border-color: var(--primary); color: var(--primary); }
        .btn-primary { background: var(--primary); color: white; border-color: var(--primary); font-weight: 600; }
        h1 { margin: 0 auto 10px; font-size: 2.5rem; display: flex; justify-content: center; align-items: center; gap: 10px; letter-spacing: -1px; }
        .subtitle { color: var(--text-sub); margin-bottom: 35px; font-size: 1.1rem; max-width: 600px; margin: 0 auto; }
        .search-container { max-width: 584px; margin: 0 auto 25px; }
        input { width: 100%; padding: 14px 24px; border-radius: 50px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text); font-size: 1.1rem; outline: none; transition: 0.2s; }
        input:focus { border-color: var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .categories { display: flex; gap: 10px; overflow-x: auto; padding: 5px 0 15px; max-width: 1000px; margin: 0 auto; justify-content: center; scrollbar-width: none; }
        .cat-pill { white-space: nowrap; padding: 8px 16px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 20px; font-size: 0.9rem; cursor: pointer; color: var(--text-sub); transition: 0.2s; }
        .cat-pill:hover, .cat-pill.active { background: var(--badge-bg); color: var(--primary); border-color: var(--primary); }
        .container { max-width: 1000px; margin: 20px auto; padding: 0 20px; flex: 1; width: 100%; box-sizing: border-box; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 20px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 12px; transition: 0.2s; cursor: pointer; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 8px 24px rgba(0,0,0,0.08); border-color: var(--primary); }
        .card-header { display: flex; justify-content: space-between; }
        .card-brand { display: flex; align-items: center; gap: 10px; flex: 1; min-width: 0; }
        .card-logo { width: 40px; height: 40px; background: var(--bg); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; border: 1px solid var(--border); }
        .card-text { flex: 1; min-width: 0; }
        .card-title { font-size: 1.1rem; font-weight: 600; color: var(--text); display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-domain { font-size: 0.8rem; color: var(--text-sub); display: block; margin-top: 2px; }
        .verified-badge { font-size: 0.75rem; color: var(--success); background: rgba(30,142,62,0.1); padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 4px; }
        .card-desc { font-size: 0.9rem; color: var(--text-sub); line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .card-footer { margin-top: auto; padding-top: 15px; border-top: 1px solid var(--bg); display: flex; justify-content: space-between; align-items: center; }
        .score-val { font-weight: 700; color: var(--primary); font-size: 1.2rem; text-align: right; }
        .score-lbl { font-size: 0.7rem; color: var(--text-sub); text-transform: uppercase; text-align: right; }
        .actions { display: flex; gap: 8px; }
        .btn-icon { width: 32px; height: 32px; border-radius: 50%; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; text-decoration: none; color: var(--text-sub); transition: 0.2s; }
        .btn-icon:hover { background: var(--bg); color: var(--primary); border-color: var(--primary); }
        .pagination { display: flex; justify-content: center; gap: 5px; margin: 40px 0; }
        .page-btn { background: var(--card-bg); border: 1px solid var(--border); padding: 8px 12px; border-radius: 6px; cursor: pointer; color: var(--text); }
        .page-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .widget-box { max-width: 800px; margin: 60px auto 20px; padding: 30px; background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border); text-align: center; }
        .code-area textarea { width: 100%; height: 80px; padding: 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; font-family: monospace; font-size: 0.8rem; color: var(--text-sub); resize: none; box-sizing: border-box; }
        footer { text-align: center; padding: 40px 20px; color: var(--text-sub); font-size: 0.9rem; border-top: 1px solid var(--border); background: var(--card-bg); }
        .credits a { color: var(--text-sub); text-decoration: none; margin: 0 5px; }
        .modal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); overflow-y: auto; }
        .modal-content { background-color: var(--card-bg); margin: 5% auto; padding: 30px; border: 1px solid var(--border); border-radius: 12px; width: 90%; max-width: 500px; color: var(--text); box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .close { float: right; font-size: 24px; font-weight: bold; cursor: pointer; color: var(--text-sub); }
        
        /* PROFILE & STARS */
        .profile-modal { z-index: 300; align-items: center; justify-content: center; display: none; }
        .profile-card { background: var(--card-bg); width: 90%; max-width: 600px; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.3); display: flex; flex-direction: column; margin: 5% auto; position: relative; border: 1px solid var(--border); }
        .profile-cover { height: 120px; background: linear-gradient(135deg, var(--primary), #0d47a1); position: relative; }
        .profile-header { padding: 20px; margin-top: -40px; display: flex; align-items: flex-end; gap: 20px; }
        .profile-logo { width: 80px; height: 80px; background: var(--card-bg); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 2px solid var(--card-bg); }
        .profile-info { flex: 1; }
        .profile-title { font-size: 1.6rem; font-weight: 700; margin: 0; color: var(--text); line-height: 1.2; }
        .profile-meta { color: var(--text-sub); font-size: 0.9rem; margin-top: 5px; }
        .profile-body { padding: 0 20px 20px; }
        .close-profile { position: absolute; top: 10px; right: 10px; color: white; background: rgba(0,0,0,0.2); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; }
        
        .rating-section { margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border); }
        .rating-stars { font-size: 1.5rem; cursor: pointer; display: inline-block; color: #ddd; }
        .rating-stars span:hover, .rating-stars span:hover ~ span { color: #FFD700; } /* Hover effect */
        .rating-stars:hover span { color: #FFD700; } /* Fill on hover */
        .rating-stars span:hover ~ span { color: #ddd; } /* Unfill after */
        
        .rating-btn { background: none; border: none; cursor: pointer; font-size: 1.5rem; color: #ddd; transition: 0.2s; }
        .rating-btn:hover { color: #FFD700; transform: scale(1.2); }
        
        @media (max-width: 600px) { .grid { grid-template-columns: 1fr; } header { padding-top: 80px; } .profile-header { flex-direction: column; align-items: flex-start; margin-top: -30px; } }
    </style>
</head>
<body>

<div id="profileModal" class="modal profile-modal" onclick="closeProfile(event)">
    <div class="profile-card" onclick="event.stopPropagation()">
        <div class="profile-cover"><div class="close-profile" onclick="closeProfile(event)">‚úï</div></div>
        <div class="profile-header">
            <div class="profile-logo" id="pLogo">üåê</div>
            <div class="profile-info">
                <h2 class="profile-title" id="pTitle">Business</h2>
                <div class="profile-meta" id="pMeta">Category</div>
            </div>
        </div>
        <div class="profile-body">
            <p id="pDesc" style="line-height: 1.6; color: var(--text); margin-bottom: 20px;">Description...</p>
            <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px;">
                <div style="flex: 1; min-width: 150px; background: var(--bg); padding: 15px; border-radius: 8px;">
                    <strong style="color:var(--text);">üìç Location</strong><br><span id="pLoc" style="color:var(--text-sub);">City</span>
                </div>
                <div style="flex: 1; min-width: 150px; background: var(--bg); padding: 15px; border-radius: 8px;">
                    <strong style="color:var(--text);">üìû Contact</strong><br><span id="pPhone" style="color:var(--text-sub);">Number</span>
                </div>
            </div>
            
            <div class="rating-section">
                <strong style="color:var(--text); display:block; margin-bottom:5px;">Rate this Business (Karma Protocol)</strong>
                <div id="starContainer">
                    <button class="rating-btn" onclick="submitRating(1)" title="1 Star">‚òÖ</button>
                    <button class="rating-btn" onclick="submitRating(2)" title="2 Stars">‚òÖ</button>
                    <button class="rating-btn" onclick="submitRating(3)" title="3 Stars">‚òÖ</button>
                    <button class="rating-btn" onclick="submitRating(4)" title="4 Stars">‚òÖ</button>
                    <button class="rating-btn" onclick="submitRating(5)" title="5 Stars">‚òÖ</button>
                </div>
                <small style="color:var(--text-sub);">Your vote is recorded anonymously via GitHub.</small>
            </div>
            
            <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                <a id="pMapBtn" href="#" target="_blank" class="btn-control">üìç Map</a>
                <a id="pSiteBtn" href="#" target="_blank" class="btn-control btn-primary">Visit ‚Üó</a>
            </div>
        </div>
    </div>
</div>

<div id="joinModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">√ó</span>
    <h2>üöÄ How to Join</h2>
    <p style="color:var(--text-sub); margin-bottom:20px;">Follow these 3 steps to list your site for free.</p>
    <div class="step"><div class="step-num">1</div><div class="step-text"><strong>Get the Files</strong><br>Go to our GitHub and download the <code>fair-discovery</code> folder.</div></div>
    <div class="step"><div class="step-num">2</div><div class="step-text"><strong>Upload & Install</strong><br>Upload the folder to your website hosting.</div></div>
    <div class="step"><div class="step-num">3</div><div class="step-text"><strong>Submit</strong><br>Click the button below to auto-add your site.</div></div>
    <div style="text-align: center; margin-top: 25px;">
        <a href="https://github.com/fair-collective/fair-discovery/issues/new?title=Add%20Site" target="_blank" class="btn-control btn-primary">üöÄ Submit Site</a>
    </div>
  </div>
</div>

<header>
    <div class="header-controls-left"><button class="btn-control" onclick="openModal()">üöÄ How to Join</button></div>
    <div class="header-controls-right">
        <select class="lang-select" onchange="changeLanguage(this.value)">
            <option value="en">üá∫üá∏ English</option><option value="es">üá™üá∏ Espa√±ol</option><option value="fr">üá´üá∑ Fran√ßais</option><option value="de">üá©üá™ Deutsch</option><option value="pt">üáßüá∑ Portugu√™s</option>
        </select>
        <button class="theme-toggle" onclick="toggleTheme()">üåô Theme</button>
    </div>
    <h1>Fair <span>Discovery</span></h1>
    <p class="subtitle">The directory ranked by real humans.</p>
    <div class="search-container"><input type="text" id="searchInput" placeholder="Try 'auto' or 'tech'..."></div>
    <div class="categories" id="catFilters">
        <div class="cat-pill active" onclick="filterCat('all')">All</div>
        <div class="cat-pill" onclick="filterCat('Auto')">üöó Auto</div>
        <div class="cat-pill" onclick="filterCat('Tech')">üíª Tech</div>
        <div class="cat-pill" onclick="filterCat('Health')">üè• Health</div>
        <div class="cat-pill" onclick="filterCat('Service')">üõ†Ô∏è Services</div>
        <div class="cat-pill" onclick="filterCat('Retail')">üõçÔ∏è Retail</div>
        <div class="cat-pill" onclick="filterCat('Artists')">üé® Artists</div>
    </div>
</header>

<div class="container">
    <div class="stats-bar"><span id="statsLabel">Loading...</span><span>Global Feed</span></div>
    <div id="resultsGrid" class="grid"></div>
    <div class="pagination" id="paginationControls"></div>
    <div class="widget-box">
        <h3>üèÜ Show off your Authority</h3>
        <p>Add the Fair Discovery seal to your site.</p>
        <div class="code-area">
            <textarea id="badgeCode" readonly><a href="https://fairdiscovery.org">üõ°Ô∏è Verified</a></textarea>
            <button class="copy-btn" onclick="copyBadge()">Copy</button>
        </div>
    </div>
</div>

<footer>
    <p class="footer-desc">Fair Discovery ranks websites based on <strong>verified human interaction</strong>.</p>
    <p>üöÄ <a href="data.json" target="_blank" class="api-link">API</a> ‚Ä¢ <a href="https://github.com/fair-collective/fair-discovery" target="_blank" class="api-link">GitHub</a></p>
    <div class="credits">Powered by Gemini ‚Ä¢ The Fair Collective</div>
</footer>

<script>
    const FEED_URL = 'data.json'; 
    let allData = [], filteredData = [], currentPage = 1; const limit = 12; let currentCategory = 'all';
    let currentBusiness = ""; // Holds the domain of the currently opened profile

    const modal = document.getElementById("joinModal");
    const profileModal = document.getElementById("profileModal");
    function openModal() { modal.style.display = "block"; }
    function closeModal() { modal.style.display = "none"; }
    function closeProfile(event) { if (event) event.stopPropagation(); profileModal.style.display = "none"; }
    window.onclick = function(event) { if (event.target == modal) closeModal(); if (event.target == profileModal) closeProfile(); }

    // --- THEME & LANG ---
    let currentLang = 'en';
    function changeLanguage(lang) { currentLang = lang; render(); }
    function toggleTheme() { const body = document.body; const isDark = body.getAttribute('data-theme') === 'dark'; body.setAttribute('data-theme', isDark ? 'light' : 'dark'); }

    // --- INIT ---
    async function init() {
        try {
            const res = await fetch(FEED_URL + '?' + Date.now());
            const json = await res.json();
            // ... (Standard parsing logic, same as before) ...
            const domainMap = {};
            (json.pages || []).forEach(page => {
                try {
                    const urlStr = page.url.startsWith('http') ? page.url : 'https://' + page.url;
                    const urlObj = new URL(urlStr);
                    const domain = urlObj.hostname;
                    if (!domainMap[domain]) {
                        domainMap[domain] = {
                            domain: domain, fullUrl: urlObj.origin, totalScore: 0, pageCount: 0,
                            category: page.category || "Service", 
                            description: page.description || "Verified listing.",
                            whatsapp: page.whatsapp || null, location: page.location || "Global"
                        };
                    }
                    domainMap[domain].totalScore += page.score;
                    domainMap[domain].pageCount++;
                    if (page.category) domainMap[domain].category = page.category;
                    if (page.description) domainMap[domain].description = page.description;
                } catch(e){}
            });
            allData = Object.values(domainMap).sort((a, b) => b.totalScore - a.totalScore);
            applyFilters();
        } catch (err) { document.getElementById('resultsGrid').innerHTML = `<p style="text-align:center">Loading...</p>`; }
    }

    // --- FORMATTING ---
    function formatTitle(domain) {
        if (domain.includes("greyzone")) return "Grey Zone Auto Parts";
        if (domain.includes("aolocksmith")) return "AO Locksmith";
        if (domain.includes("autods")) return "Auto Digital Solutions";
        if (domain.includes("bookkeepers")) return "Bookkeepers SA";
        if (domain.includes("seritipbo")) return "Seriti PBO";
        if (domain.includes("scouts")) return "Save Our Children";
        if (domain.includes("jotto")) return "Jotto's Portfolio";
        if (domain.includes("skyrope")) return "Sky Rope Specialist";
        if (domain.includes("intpanel")) return "International Panel Shop";
        let t = domain.split('.')[1] || domain.split('.')[0]; 
        return t.charAt(0).toUpperCase() + t.slice(1);
    }
    
    function formatScore(num) { if (num > 1000000) return (num/1000000).toFixed(1) + 'M'; if (num > 1000) return (num/1000).toFixed(1) + 'k'; return num; }

    // --- FILTERING ---
    function filterCat(cat) { currentCategory = cat; document.querySelectorAll('.cat-pill').forEach(el => el.classList.remove('active')); event.target.classList.add('active'); applyFilters(); }
    function applyFilters() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        filteredData = allData.filter(item => {
            const matchesCat = currentCategory === 'all' || item.category === currentCategory;
            const text = (item.domain + item.description + item.category).toLowerCase();
            return matchesCat && text.includes(term);
        });
        currentPage = 1; render();
    }

    // --- PROFILE & RATING LOGIC ---
    function openProfile(index) {
        const item = filteredData[index];
        if (!item) return;
        
        currentBusiness = formatTitle(item.domain); // Store for rating
        
        document.getElementById('pTitle').innerText = currentBusiness;
        document.getElementById('pMeta').innerText = `${item.category} ‚Ä¢ ${item.location}`;
        document.getElementById('pDesc').innerText = item.description;
        document.getElementById('pLoc').innerText = item.location;
        document.getElementById('pPhone').innerText = item.whatsapp ? '+' + item.whatsapp : 'N/A';
        
        let visitLink = item.fullUrl;
        if (item.domain.includes(".local") && item.whatsapp) visitLink = `https://wa.me/${item.whatsapp}`;
        document.getElementById('pSiteBtn').href = visitLink;
        
        // Map link logic (simplified)
        document.getElementById('pMapBtn').href = `http://maps.google.com/?q=${currentBusiness} ${item.location}`;

        document.getElementById('profileModal').style.display = 'flex';
    }

    function submitRating(stars) {
        // Opens a GitHub Issue with the pre-filled Rating Template
        const title = `Rating: ${stars} Stars for ${currentBusiness}`;
        const body = `I am rating **${currentBusiness}**.\n\nScore: ${stars}/5\n\n(The automated judge will analyze my history to prevent spam.)`;
        const link = `https://github.com/fair-collective/fair-discovery/issues/new?title=${encodeURIComponent(title)}&body=${encodeURIComponent(body)}`;
        
        window.open(link, '_blank');
    }

    function render() {
        const grid = document.getElementById('resultsGrid'); grid.innerHTML = ''; 
        document.getElementById('statsLabel').innerText = `Found ${filteredData.length} sites`;
        
        const start = (currentPage - 1) * limit;
        const pageItems = filteredData.slice(start, start + limit);
        
        pageItems.forEach((item, index) => {
            let globalIndex = start + index;
            let flag = item.domain.endsWith('.za') ? 'üáøüá¶' : 'üåê';
            const card = `
            <div class="card" onclick="openProfile(${globalIndex})">
                <div class="card-header"><div class="card-brand"><div class="card-logo">${flag}</div><div class="card-text"><span class="card-title">${formatTitle(item.domain)}</span><span class="card-domain">${item.domain.replace('.local','')}</span></div></div></div>
                <div class="card-desc">${item.description}</div>
                <div class="card-footer"><div class="score-box"><div class="score-val">${formatScore(item.totalScore)}</div><div class="score-lbl">Authority</div></div></div>
            </div>`;
            grid.insertAdjacentHTML('beforeend', card);
        });
        
        // Simple pagination (Previous/Next)
        const controls = document.getElementById('paginationControls');
        controls.innerHTML = '';
        if (filteredData.length > limit) {
            controls.innerHTML = `
                <button class="page-btn" onclick="currentPage--; render()" ${currentPage===1?'disabled':''}>¬´</button>
                <button class="page-btn" onclick="currentPage++; render()" ${currentPage * limit >= filteredData.length?'disabled':''}>¬ª</button>
            `;
        }
    }

    function copyBadge() {
        const copyText = document.getElementById("badgeCode");
        copyText.select();
        navigator.clipboard.writeText(copyText.value);
        alert("Code copied!");
    }

    document.getElementById('searchInput').addEventListener('input', applyFilters);
    init();
</script>
</body>
</html>
