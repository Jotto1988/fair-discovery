<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Fair Discovery: The decentralized, AI-ranked directory of authentic businesses.">
    <meta name="theme-color" content="#1a73e8">
    <title>Fair Discovery Directory</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%231a73e8'/%3E%3Ccircle cx='42' cy='42' r='24' stroke='white' stroke-width='12' fill='none'/%3E%3Cline x1='60' y1='60' x2='85' y2='85' stroke='white' stroke-width='12' stroke-linecap='round'/%3E%3C/svg%3E">

    <style>
        /* --- VARIABLES --- */
        :root {
            --bg: #f8f9fa; --card-bg: #ffffff; --text: #202124; --text-sub: #5f6368; 
            --border: #dadce0; --shadow: 0 2px 8px rgba(0,0,0,0.08);
            --accent: #1a73e8; --success: #188038;
        }
        [data-theme="dark"] {
            --bg: #202124; --card-bg: #303134; --text: #e8eaed; --text-sub: #9aa0a6;
            --border: #3c4043; --shadow: 0 4px 12px rgba(0,0,0,0.3);
            --accent: #8ab4f8; --success: #81c995;
        }

        body { font-family: 'Google Sans', 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; min-height: 100vh; transition: background 0.3s; }

        /* HEADER */
        header {
            background: linear-gradient(180deg, var(--card-bg) 0%, var(--bg) 100%);
            padding: 40px 20px 30px; text-align: center;
            border-bottom: 1px solid var(--border); position: relative;
        }
        .header-controls-right { position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; }
        .header-controls-left { position: absolute; top: 20px; left: 20px; }

        .btn-control, .lang-select, .theme-toggle { 
            background: var(--card-bg); border: 1px solid var(--border); color: var(--text); 
            padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; 
            transition: 0.2s; outline: none; text-decoration: none; display: inline-block;
            font-family: inherit;
        }
        .lang-select {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            padding-right: 25px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="%235f6368" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>');
            background-repeat: no-repeat; background-position: right 8px center;
        }
        .btn-control:hover, .lang-select:hover, .theme-toggle:hover { background: var(--bg); border-color: var(--accent); color: var(--accent); }
        .btn-primary { background: var(--accent); color: white; border-color: var(--accent); font-weight: 600; }
        .btn-primary:hover { background: #155db1; color: white; }

        h1 { margin: 0 auto 10px; font-size: 2.2rem; display: flex; justify-content: center; align-items: center; gap: 10px; letter-spacing: -1px; }
        h1 span { font-weight: 300; opacity: 0.8; }
        .subtitle { color: var(--text-sub); margin-bottom: 25px; font-size: 1rem; max-width: 600px; margin-left: auto; margin-right: auto; }

        /* SEARCH & FILTERS */
        .filter-bar {
            display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; max-width: 800px; margin: 0 auto;
        }
        
        .search-wrapper {
            flex: 1; min-width: 250px; position: relative; display: flex; align-items: center;
        }
        
        .search-box {
            width: 100%; padding: 12px 45px 12px 20px; border-radius: 24px; 
            border: 1px solid var(--border); background: var(--card-bg); color: var(--text);
            font-size: 1rem; outline: none; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            box-sizing: border-box;
        }
        .search-box:focus { border-color: var(--accent); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        .geo-btn { position: absolute; right: 12px; background: none; border: none; cursor: pointer; font-size: 1.2rem; opacity: 0.6; }
        .geo-btn:hover { opacity: 1; color: var(--accent); }

        .custom-select {
            padding: 12px 30px 12px 20px; border-radius: 24px; border: 1px solid var(--border);
            background: var(--card-bg) url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="%23555"><path d="M2 4l4 4 4-4"/></svg>') no-repeat right 12px center;
            color: var(--text); font-size: 0.9rem; cursor: pointer; appearance: none; min-width: 140px;
        }

        /* CATEGORY PILLS (Horizontal Scroll) */
        .category-scroll { 
            display: flex; gap: 8px; overflow-x: auto; padding: 15px 0 5px; 
            justify-content: center; scrollbar-width: none; mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);
        }
        .cat-pill {
            padding: 6px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: 500;
            background: var(--bg); border: 1px solid var(--border); cursor: pointer;
            color: var(--text-sub); transition: 0.2s; white-space: nowrap;
        }
        .cat-pill:hover, .cat-pill.active { background: var(--accent); color: white; border-color: var(--accent); }

        /* GRID */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; flex: 1; }
        .stats-bar { display: flex; justify-content: space-between; color: var(--text-sub); font-size: 0.85rem; margin-bottom: 15px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }

        /* CARD */
        .card {
            background: var(--card-bg); border-radius: 12px; overflow: hidden;
            border: 1px solid var(--border); box-shadow: var(--shadow);
            transition: transform 0.2s; cursor: pointer; display: flex; flex-direction: column; gap: 10px;
        }
        .card:hover { transform: translateY(-3px); border-color: var(--accent); }
        
        /* SMART BANNER IMAGES */
        .card-banner { height: 90px; background-size: cover; background-position: center; position: relative; }
        .card-banner::after { content:''; position:absolute; inset:0; background: rgba(0,0,0,0.1); }
        
        .card-content { padding: 0 16px 16px; flex: 1; display: flex; flex-direction: column; margin-top: -25px; position: relative; z-index: 2; }
        
        .card-brand { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 8px; }
        .card-logo { 
            width: 48px; height: 48px; border-radius: 10px; background: var(--card-bg); 
            display: flex; align-items: center; justify-content: center; font-size: 1.5rem; 
            border: 2px solid var(--card-bg); box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        .verified-tag { background: rgba(24,128,56,0.1); color: var(--success); padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; margin-bottom: 5px; }

        .card-title { font-size: 1.1rem; font-weight: 700; margin: 0; color: var(--text); line-height: 1.3; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-meta { font-size: 0.8rem; color: var(--text-sub); margin: 4px 0 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* DEAL BADGE (Only shows if real) */
        .deal-badge { 
            background: #ffeff5; color: #d63384; font-size: 0.7rem; padding: 4px 8px; 
            border-radius: 4px; font-weight: 700; display: inline-block; margin-bottom: 8px;
            border: 1px solid #f8d7da;
        }

        .card-desc { font-size: 0.9rem; color: var(--text-sub); line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; margin-bottom: 10px; }

        .card-footer { margin-top: auto; padding-top: 12px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; }
        .score-val { font-weight: 700; color: var(--accent); font-size: 1rem; }

        /* IMAGES (UNSPLASH) */
        .bg-auto { background-image: url('https://images.unsplash.com/photo-1486262715619-01b8c22973f5?auto=format&fit=crop&w=600&q=80'); }
        .bg-tech { background-image: url('https://images.unsplash.com/photo-1518770660439-4636190af475?auto=format&fit=crop&w=600&q=80'); }
        .bg-health { background-image: url('https://images.unsplash.com/photo-1505751172876-fa1923c5c528?auto=format&fit=crop&w=600&q=80'); }
        .bg-service { background-image: url('https://images.unsplash.com/photo-1581578077058-612788a8966c?auto=format&fit=crop&w=600&q=80'); }
        .bg-retail { background-image: url('https://images.unsplash.com/photo-1441986300917-64674bd600d8?auto=format&fit=crop&w=600&q=80'); }
        .bg-art { background-image: url('https://images.unsplash.com/photo-1460661419201-fd4cecdf8a8b?auto=format&fit=crop&w=600&q=80'); }
        .bg-property { background-image: url('https://images.unsplash.com/photo-1560518883-ce09059eeffa?auto=format&fit=crop&w=600&q=80'); }
        .bg-travel { background-image: url('https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1?auto=format&fit=crop&w=600&q=80'); }

        /* MODAL */
        .modal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); overflow-y: auto; }
        .modal-content { background-color: var(--card-bg); margin: 5% auto; padding: 30px; border: 1px solid var(--border); border-radius: 12px; width: 90%; max-width: 500px; color: var(--text); box-shadow: 0 10px 25px rgba(0,0,0,0.2); position: relative; }
        .modal h2 { margin-top: 0; color: var(--accent); }
        .close { float: right; font-size: 24px; font-weight: bold; cursor: pointer; color: var(--text-sub); }
        .step { display: flex; gap: 15px; margin-bottom: 20px; align-items: flex-start; }
        .step-num { background: var(--badge-bg); color: var(--accent); width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; font-size: 0.9rem; }
        .fallback-details { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border); font-size: 0.9rem; }
        .fallback-toggle { color: var(--text-sub); cursor: pointer; text-decoration: underline; font-size: 0.85rem; }
        .fallback-content { display: none; margin-top: 15px; background: var(--bg); padding: 15px; border-radius: 8px; text-align: left; }
        .fallback-content pre { background: #000; color: #0f0; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 0.75rem; }

        /* PROFILE MODAL */
        .profile-modal { z-index: 300; align-items: center; justify-content: center; display: none; }
        .profile-card { background: var(--card-bg); width: 90%; max-width: 600px; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.3); display: flex; flex-direction: column; margin: 5% auto; position: relative; border: 1px solid var(--border); }
        
        .profile-cover { 
            height: 140px; 
            background: linear-gradient(135deg, var(--accent), #0d47a1); 
            position: relative;
            display: flex; align-items: center; justify-content: center;
            padding: 20px; text-align: center; color: rgba(255,255,255,0.9);
        }
        .quote-text { font-family: serif; font-style: italic; font-size: 1rem; line-height: 1.4; max-width: 80%; }
        
        .profile-header { padding: 20px; margin-top: -40px; display: flex; align-items: flex-end; gap: 20px; }
        .profile-logo { width: 80px; height: 80px; background: var(--card-bg); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 2px solid var(--card-bg); }
        .profile-info { flex: 1; }
        .profile-title { font-size: 1.6rem; font-weight: 700; margin: 0; color: var(--text); line-height: 1.2; }
        .profile-meta { color: var(--text-sub); font-size: 0.9rem; margin-top: 5px; }
        .profile-body { padding: 0 20px 20px; }
        .profile-actions { padding: 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; background: var(--bg); }
        .close-profile { position: absolute; top: 10px; right: 10px; color: white; background: rgba(0,0,0,0.2); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; border: 1px solid rgba(255,255,255,0.3); }
        
        .rating-section { margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border); }
        .rating-btn { background: none; border: none; cursor: pointer; font-size: 1.5rem; color: #ddd; transition: 0.2s; }
        .rating-btn:hover { color: #FFD700; transform: scale(1.2); }

        /* FOOTER */
        footer { margin-top: 40px; padding: 30px; text-align: center; border-top: 1px solid var(--border); color: var(--text-sub); font-size: 0.85rem; }
        .api-link { color: var(--accent); font-weight: 600; text-decoration: none; }

        @media (max-width: 600px) {
            .grid { grid-template-columns: 1fr; }
            .filter-bar { flex-direction: column; align-items: stretch; }
            .modal-card { width: 100%; height: 100%; border-radius: 0; margin: 0; max-width: none; }
            .profile-header { flex-direction: column; align-items: flex-start; gap: 10px; margin-top: -30px; }
        }
    </style>
</head>
<body>

<header>
    <div class="header-controls-left">
        <button class="btn-control" onclick="openModal('join')">üöÄ Join</button>
    </div>
    <div class="header-controls-right">
        <select class="lang-select" onchange="changeLanguage(this.value)">
            <option value="en">üá∫üá∏ English</option><option value="es">üá™üá∏ Espa√±ol</option><option value="fr">üá´üá∑ Fran√ßais</option><option value="de">üá©üá™ Deutsch</option><option value="pt">üáßüá∑ Portugu√™s</option>
        </select>
        <button class="theme-toggle" onclick="toggleTheme()" data-i18n="theme">üåô Theme</button>
    </div>

    <h1 style="display: flex; align-items: center; justify-content: center; gap: 12px;">
        <svg width="40" height="40" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
            <defs><linearGradient id="logoGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#1a73e8;stop-opacity:1" /><stop offset="100%" style="stop-color:#8ab4f8;stop-opacity:1" /></linearGradient></defs>
            <path d="M50 5 L90 20 V50 C90 75 50 95 50 95 C50 95 10 75 10 50 V20 Z" fill="url(#logoGrad)" />
            <circle cx="50" cy="45" r="16" stroke="white" stroke-width="6" fill="none" />
            <line x1="60" y1="55" x2="72" y2="67" stroke="white" stroke-width="6" stroke-linecap="round" />
        </svg>
        <span>Fair Discovery</span>
    </h1>
    <p class="subtitle" data-i18n="subtitle">The directory ranked by real humans, not bots.</p>

    <div class="filter-bar">
        <div class="search-wrapper">
            <input type="text" class="search-box" id="searchInput" placeholder="Search businesses...">
            <button class="geo-btn" onclick="geoFindMe()">üìç</button>
        </div>
        
        <select id="catFilter" class="custom-select" onchange="filter()">
            <option value="all">All Categories</option>
            <option value="Auto">üöó Auto</option>
            <option value="Tech">üíª Tech</option>
            <option value="Health">üè• Health</option>
            <option value="Service">üõ†Ô∏è Services</option>
            <option value="Retail">üõçÔ∏è Retail</option>
            <option value="Artists">üé® Artists</option>
            <option value="Real Estate">üè† Property</option>
            <option value="Travel">‚úàÔ∏è Holiday</option>
        </select>

        <select id="locFilter" class="custom-select" onchange="filter()">
            <option value="all">üåç Global</option>
        </select>
    </div>
</header>

<div class="container">
    <div class="stats-bar">
        <span id="countLabel">Loading...</span>
        <span>Network Live</span>
    </div>
    <div id="grid" class="grid"></div>
    <div class="pagination" id="pagination"></div>
</div>

<footer>
    <p>Fair Discovery ¬© 2025 ‚Ä¢ Decentralized & Open Source</p>
    <div style="margin: 20px 0;">
        <a href="https://www.buymeacoffee.com/Prinymity" target="_blank" style="background:#FFDD00; color:black; padding:8px 16px; border-radius:20px; font-weight:bold; text-decoration:none;">‚òï Support the Dev</a>
    </div>
    <p style="opacity:0.6;">Powered by Gemini ‚Ä¢ GitHub ‚Ä¢ The Fair Collective ‚Ä¢ <a href="data.json" target="_blank" class="api-link">API</a></p>
</footer>

<div id="profileModal" class="modal profile-modal" onclick="closeModal('profile')">
    <div class="profile-card" onclick="event.stopPropagation()">
        <div id="mBanner" class="modal-banner bg-service">
            <div class="close-profile" onclick="closeModal('profile')">‚úï</div>
            <div class="quote-text" id="mQuote">"Truth is the only safe ground."</div>
        </div>
        <div class="modal-body">
            <div class="profile-header">
                <div class="profile-logo" id="mLogo">üåê</div>
                <div class="profile-info">
                    <h2 class="profile-title" id="mTitle">Business Name</h2>
                    <div class="profile-meta" id="mMeta">Category ‚Ä¢ Loc</div>
                </div>
            </div>
            
            <p id="mDesc" style="color:var(--text); line-height:1.6; margin-bottom:20px;">Desc</p>

            <div class="info-grid">
                <div class="info-box">
                    <span class="info-label">üìç Location</span>
                    <div id="mLoc">City</div>
                </div>
                <div class="info-box">
                    <span class="info-label">üìû Contact</span>
                    <div id="mPhone">Number</div>
                </div>
            </div>

            <a id="mLink" href="#" target="_blank" class="btn-primary">Visit Website ‚Üó</a>
            
            <div class="rating-section">
                <strong style="color:var(--text); display:block; margin-bottom:5px;">Rate this Business</strong>
                <div id="starContainer">
                    <button class="rating-btn" onclick="submitRating(1)" title="1 Star">‚òÖ</button>
                    <button class="rating-btn" onclick="submitRating(2)" title="2 Stars">‚òÖ</button>
                    <button class="rating-btn" onclick="submitRating(3)" title="3 Stars">‚òÖ</button>
                    <button class="rating-btn" onclick="submitRating(4)" title="4 Stars">‚òÖ</button>
                    <button class="rating-btn" onclick="submitRating(5)" title="5 Stars">‚òÖ</button>
                </div>
                <small style="color:var(--text-sub);">Your vote is recorded anonymously via Google Forms.</small>
            </div>
        </div>
    </div>
</div>

<div id="joinModal" class="modal-backdrop" onclick="closeModal('join')">
    <div class="modal-card" onclick="event.stopPropagation()">
        <div class="modal-body" style="text-align:center;">
            <div class="close" onclick="closeModal('join')" style="position:absolute; top:15px; right:15px;">‚úï</div>
            <h2 style="margin-top:0;">üöÄ How to Join</h2>
            <p>1. Download the `fair-discovery` folder from GitHub.<br>2. Upload to your site root.<br>3. Submit your URL below.</p>
            <a href="https://github.com/fair-collective/fair-discovery/issues/new?title=Add%20Site" target="_blank" class="btn-primary">Submit Site</a>
            
            <div class="fallback-details">
                <span class="fallback-toggle" onclick="toggleFallback()">Click here for manual submission</span>
                <div id="fallbackContent" class="fallback-content">
                    <p><strong>Firewall Blocking?</strong> Open a Manual Entry issue:</p>
                    <a href="https://github.com/fair-collective/fair-discovery/issues/new?title=Manual%20Entry" target="_blank" style="display:block; margin-top:10px; color:var(--accent); font-weight:bold;">üëâ Open Manual Ticket</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const FEED = 'data.json';
    let allData = [], filtered = [];
    let curCat = 'all';
    let currentBiz = "";
    
    const quotes = [
        "\"Quality means doing it right when no one is looking.\"",
        "\"Truth is the only safe ground to stand upon.\"",
        "\"Honesty is the first chapter in the book of wisdom.\"",
        "\"Fairness is a professional skill.\""
    ];

    const i18n = {
        en: { subtitle: "The directory ranked by real humans, not bots.", search_ph: "Search services...", join: "Join", cat_all: "All Categories", cat_auto: "üöó Auto", cat_tech: "üíª Tech", cat_service: "üõ†Ô∏è Services", loc_global: "üåç Global" },
        es: { subtitle: "El directorio descentralizado.", search_ph: "Buscar servicios...", join: "Unirse", cat_all: "Todas", cat_auto: "üöó Autos", cat_tech: "üíª Tec", cat_service: "üõ†Ô∏è Servicios", loc_global: "üåç Global" },
        fr: { subtitle: "L'annuaire d√©centralis√©.", search_ph: "Rechercher...", join: "Rejoindre", cat_all: "Toutes", cat_auto: "üöó Auto", cat_tech: "üíª Tech", cat_service: "üõ†Ô∏è Services", loc_global: "üåç Global" }
    };

    function setLang(lang) {
        const t = i18n[lang] || i18n.en;
        document.querySelectorAll('[data-i18n]').forEach(e => e.innerText = t[e.dataset.i18n]);
        document.querySelectorAll('[data-i18n-ph]').forEach(e => e.placeholder = t[e.dataset.i18nPh]);
    }

    function toggleTheme() {
        const b = document.body;
        b.setAttribute('data-theme', b.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
    }

    async function init() {
        try {
            const res = await fetch(FEED + '?' + Date.now());
            const json = await res.json();
            processData(json.pages || []);
        } catch (e) { document.getElementById('grid').innerHTML = '<p style="text-align:center">Loading...</p>'; }
    }

    function processData(pages) {
        const map = {};
        pages.forEach(p => {
            try {
                let d = new URL(p.url.startsWith('http')?p.url:'https://'+p.url).hostname;
                if(!map[d]) map[d] = {
                    domain: d, url: p.url, score: 0, 
                    cat: p.category || inferCat(d), 
                    desc: p.description || "Verified listing.",
                    wa: p.whatsapp, loc: p.location || "Global",
                    deal: p.deal
                };
                map[d].score += p.score;
                if(p.category) map[d].cat = p.category;
                if(p.description) map[d].desc = p.description;
            } catch(e){}
        });
        allData = Object.values(map).sort((a,b) => b.score - a.score);
        
        const locs = new Set();
        allData.forEach(i => {
            if(i.loc) {
                locs.add(i.loc);
                if(i.loc.includes(',')) locs.add(i.loc.split(',')[1].trim());
            }
        });
        const sortedLocs = [...locs].sort();
        const sel = document.getElementById('locFilter');
        sortedLocs.forEach(l => {
            if(l && l !== "Global") sel.innerHTML += `<option value="${l}">üìç ${l}</option>`;
        });
        filter();
    }

    function inferCat(d) {
        d = d.toLowerCase();
        if(d.includes('auto')||d.includes('panel')||d.includes('motor')) return 'Auto';
        if(d.includes('tech')||d.includes('app')) return 'Tech';
        if(d.includes('health')) return 'Health';
        if(d.includes('art')) return 'Artists';
        if(d.includes('property')) return 'Real Estate';
        return 'Service';
    }

    function formatTitle(d) {
        if(d.includes("greyzone")) return "Grey Zone Auto Parts";
        if(d.includes("aolocksmith")) return "AO Locksmith";
        if(d.includes("autods")) return "Auto Digital Solutions";
        if(d.includes("bookkeepers")) return "Bookkeepers SA";
        if(d.includes("seritipbo")) return "Seriti PBO";
        if(d.includes("scouts")) return "Save Our Children";
        if(d.includes("jotto")) return "Jotto's Portfolio";
        if(d.includes("skyrope")) return "Sky Rope Specialist";
        if(d.includes("intpanel")) return "International Panel Shop";
        return d.split('.')[0].charAt(0).toUpperCase() + d.split('.')[0].slice(1);
    }

    function getBannerClass(cat) {
        const c = cat.toLowerCase();
        if(c.includes('auto')) return 'bg-auto';
        if(c.includes('tech')) return 'bg-tech';
        if(c.includes('health')) return 'bg-health';
        if(c.includes('art')) return 'bg-art';
        if(c.includes('retail')) return 'bg-retail';
        if(c.includes('estate') || c.includes('property')) return 'bg-property';
        if(c.includes('travel') || c.includes('holiday')) return 'bg-travel';
        return 'bg-service';
    }

    function filter() {
        const cat = document.getElementById('catFilter').value;
        const term = document.getElementById('searchInput').value.toLowerCase();
        const loc = document.getElementById('locFilter').value;
        
        filtered = allData.filter(i => {
            const matchCat = cat === 'all' || i.cat === cat;
            let matchLoc = loc === 'all';
            if (!matchLoc && i.loc) matchLoc = i.loc.includes(loc);
            const text = (i.domain + i.desc + i.cat + i.loc + formatTitle(i.domain)).toLowerCase();
            return matchCat && matchLoc && text.includes(term);
        });
        render();
    }

    function render() {
        const grid = document.getElementById('grid'); grid.innerHTML = '';
        document.getElementById('countLabel').innerText = `Found ${filtered.length} sites`;
        
        const start = (currentPage - 1) * 12;
        const slice = filtered.slice(start, start + 12);
        
        slice.forEach((item, idx) => {
            let flag = item.domain.endsWith('.za') ? 'üáøüá¶' : 'üåê';
            let bannerClass = getBannerClass(item.cat);
            let dealBadge = item.deal ? `<div class="deal-badge">üî• ${item.deal}</div>` : '';
            
            const card = document.createElement('div');
            card.className = 'card';
            card.onclick = () => openModal(idx);
            card.innerHTML = `
                <div class="card-banner ${bannerClass}"></div>
                <div class="card-content">
                    <div class="card-brand">
                        <div class="card-logo">${flag}</div>
                        <span class="verified-tag">‚úì Verified</span>
                    </div>
                    <h3 class="card-title">${formatTitle(item.domain)}</h3>
                    <div class="card-meta">${item.domain.replace('.local','')}</div>
                    ${dealBadge}
                    <p class="card-desc">${item.desc}</p>
                    <div class="card-footer">
                        <span style="font-weight:500;">${item.cat}</span>
                        <div>
                            <span class="score-val">${(item.score > 1000 ? (item.score/1000).toFixed(1)+'k' : item.score)}</span>
                            <span class="score-lbl">Auth</span>
                        </div>
                    </div>
                </div>
            `;
            grid.appendChild(card);
        });
        renderPag();
    }

    function openModal(idx) {
        const i = filtered[idx];
        currentBiz = formatTitle(i.domain);
        
        const banner = document.getElementById('mBanner');
        banner.className = 'modal-banner ' + getBannerClass(i.cat);
        document.getElementById('mQuote').innerText = quotes[Math.floor(Math.random()*quotes.length)];
        
        document.getElementById('mTitle').innerText = currentBiz;
        document.getElementById('mMeta').innerText = `${i.cat} ‚Ä¢ ${i.loc}`;
        document.getElementById('mDesc').innerText = i.desc;
        document.getElementById('mLoc').innerText = i.loc;
        document.getElementById('mPhone').innerText = i.wa ? '+' + i.wa : 'N/A';
        
        let link = i.url;
        if(i.domain.includes('.local') && i.wa) link = `https://wa.me/${i.wa}`;
        document.getElementById('mLink').href = link;
        
        // Smart Map Link
        let map = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(currentBiz + ' ' + i.loc)}`;
        if(i.domain.includes('greyzone')) map = "https://share.google/1O2Kl72Vige48vGsB";
        if(i.domain.includes('aolocksmith')) map = "https://share.google/WNjzMAwNlj9tC3u6F";
        document.getElementById('pMapBtn').href = map;

        document.getElementById('profileModal').style.display = 'flex';
    }

    function closeModal(id) {
        if(id === 'join') document.getElementById('joinModal').style.display = 'none';
        else document.getElementById('profileModal').style.display = 'none';
    }
    function openJoin() { document.getElementById('joinModal').style.display = 'flex'; }
    function toggleFallback() { const el = document.getElementById("fallbackContent"); el.style.display = (el.style.display === "block") ? "none" : "block"; }
    function geoFindMe() { alert("Location search coming soon!"); }
    
    function rate(stars) {
        const formId = "1FAIpQLSefrTrv68_G_l-6-6J41szCGqg_DcTxklCcWAPJ6e-_oV0k8A";
        const url = `https://docs.google.com/forms/d/e/${formId}/viewform?usp=pp_url&entry.1871531298=${encodeURIComponent(currentBiz)}&entry.741708013=${stars}`;
        window.open(url, '_blank');
    }

    function renderPag() {
        const el = document.getElementById('pagination'); el.innerHTML = '';
        const pages = Math.ceil(filtered.length / 12);
        if(pages <= 1) return;
        for(let i=1; i<=pages; i++) {
            el.innerHTML += `<button class="page-btn ${i===currentPage?'active':''}" onclick="currentPage=${i};render();window.scrollTo(0,0)">${i}</button>`;
        }
    }

    document.getElementById('searchInput').addEventListener('input', filter);
    init();
</script>
</body>
</html>
